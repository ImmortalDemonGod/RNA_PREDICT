# -*- coding: utf-8 -*-
"""demo.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1rAWP7evVLc7cbIP3KzPr5ZlHTVo9A57g

## Reproduce the results in the paper

### Download the RFold code, checkpoints, and datasets
"""

!git clone https://github.com/A4Bio/RFold
!wget -O RFold/checkpoints.zip https://www.dropbox.com/s/l04l9bf3v6z2tfd/checkpoints.zip?dl=0
!wget -O RFold/data.zip https://www.dropbox.com/s/wzbkd3q43haax0r/data.zip?dl=0
!unzip -o RFold/checkpoints.zip -d RFold/
!unzip -o RFold/data.zip -d RFold/

"""### Import packages"""

import os
os.chdir('/content/RFold')

import torch
import json
import argparse
import collections
from RFold.main import Exp

RNA_SS_data = collections.namedtuple('RNA_SS_data', 'seq ss_label length name pairs')

"""### Predefined paths of checkpoints and configs"""

pretrained_file = {
    'RNAStralign': {
        'config': './checkpoints/RNAStralign.json',
        'checkpoint': './checkpoints/RNAStralign_trainset_pretrained.pth'
    },
    'ArchiveII': {
        'config': './checkpoints/ArchiveII.json',
        'checkpoint': './checkpoints/RNAStralign_trainset_pretrained.pth'
    },
    'bpRNA': {
        'config': './checkpoints/bpRNA.json',
        'checkpoint': './checkpoints/bpRNA_trainset_pretrained.pth'
    }
}

"""### Reproduce the results"""

for data_name in ['RNAStralign', 'ArchiveII', 'bpRNA']:
    config = json.load(open(pretrained_file[data_name]['config'], 'r'))
    args = argparse.Namespace(**config)
    exp = Exp(args)
    exp.method.model.load_state_dict(torch.load(pretrained_file[data_name]['checkpoint']))
    exp.test()

"""## Predict a single sequence"""

name = 'test'
sequence = 'AAGUCUGGUGGACAUUGGCGUCCUGAGGUGUUAAAACCUCUUAUUGCUGACGCCAGAAAGAGAAGAACUUCGGUUCUACUAGUCGACUAUACUACAAGCUUUGGGUGUAUAGCGGCAAGACAACCUGGAUCGGGGGAGGCUAAGGGCGCAAGCCUAUGCUAACCCCGAGCCGAGCUACUGGAGGGCAACCCCCAGAUAGCCGGUGUAGAGCGCGGAAAGGUGUCGGUCAUCCUAUCUGAUAGGUGGCUUGAGGGACGUGCCGUCUCACCCGAAAGGGUGUUUCUAAGGAGGAGCUCCCAAAGGGCAAAUCUUAGAAAAGGGUGUAUACCCUAUAAUUUAACGGCCAGCAGCC'

import json
from RFold.colab_utils import process_seqs, row_col_argmax, constraint_matrix, save_ct, visual_get_bases

config = json.load(open(pretrained_file['RNAStralign']['config'], 'r'))
args = argparse.Namespace(**config)
exp = Exp(args)
exp.method.model.load_state_dict(torch.load(pretrained_file['RNAStralign']['checkpoint']))

"""### process the sequence"""

nseq, nseq_one_hot, seq_len = process_seqs(sequence, exp.device)

"""### make the predicion"""

raw_pred = exp.method.model(nseq)
preds = row_col_argmax(raw_pred) * constraint_matrix(nseq_one_hot)

"""### save ct file"""

save_ct(preds[0, :seq_len, :seq_len], nseq_one_hot[0, :seq_len], name)

"""### visualize the contact map"""

import matplotlib.pyplot as plt

plt.figure()
plt.axis('off')
plt.imshow(preds.cpu().numpy()[0], cmap='GnBu')

"""### visualize the RNA secondary structure"""

import subprocess
from RFold.colab_utils import process_seqs, row_col_argmax, constraint_matrix, save_ct, visual_get_bases

# name = 'test'
a_bases, u_bases, c_bases, g_bases = visual_get_bases(sequence)
subprocess.Popen(["java", "-cp", "VARNAv3-93.jar",
    "fr.orsay.lri.varna.applications.VARNAcmd",
    '-i', './'+name+'.ct',
    '-basesStyle1', 'fill=#FF0000,outline=#FF0000,label=#FFFFFF,number=#FF0000',
    '-applyBasesStyle1on', a_bases,
    '-basesStyle2', 'fill=#FF6600,outline=#FF6600,label=#FFFFFF,number=#FF6600',
    '-applyBasesStyle2on', u_bases,
    '-basesStyle3', 'fill=#FFFF008,outline=#FFFF008,label=#000000,number=#FFFF008',
    '-applyBasesStyle3on', c_bases,
    '-basesStyle4', 'fill=#00FFFF,outline=#00FFFF,label=#000000,number=#00FFFF',
    '-applyBasesStyle4on', g_bases,
    '-o', './'+name+'.png',
    '-resolution', '8.0'],
    stderr=subprocess.STDOUT, stdout=subprocess.PIPE).communicate()[0]

from PIL import Image
import matplotlib.pyplot as plt

plt.figure(figsize=(10, 10))
plt.axis('off')
plt.imshow(Image.open(name+'.png'))