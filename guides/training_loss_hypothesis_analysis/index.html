
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>RNA_PREDICT Training & Loss Function: Hypothesis-Driven Analysis - rna_predict</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#rna_predict-training-loss-function-hypothesis-driven-analysis" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="rna_predict" class="md-header__button md-logo" aria-label="rna_predict" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            rna_predict
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              RNA_PREDICT Training &amp; Loss Function: Hypothesis-Driven Analysis
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="rna_predict" class="md-nav__button md-logo" aria-label="rna_predict" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    rna_predict
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting_started/windows_compatibility_plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Windows Compatibility
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Best Practices
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Best Practices
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../best_practices/code_quality_best_practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Quality
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2_2" id="__nav_2_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Testing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../best_practices/testing/test_coverage_strategy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coverage Strategy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../best_practices/testing/progressive_coverage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Progressive Coverage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../best_practices/testing/test_generation_prompt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Test Generation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_2_3" id="__nav_2_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Debugging
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Debugging
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../best_practices/debugging/comprehensive_debugging_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comprehensive Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Pipeline
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Pipeline
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Overview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/overview/core_framework/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core Framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/overview/Integrated_RNA_3D_Prediction_Pipeline_Final_Comprehensive_Design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Comprehensive Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/overview/full_pipeline_specification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Full Specification
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/overview/Multi_Stage_Implementation_Plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Stage Plan
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/Integrated_RNA_3D_Prediction_Pipeline_Final_Comprehensive_Design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/full_pipeline_specification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Full Specification
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_3" >
        
          
          <label class="md-nav__link" for="__nav_3_2_3" id="__nav_3_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Hydra Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Hydra Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/hydra_integration/hydra_tutorial/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tutorial
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/hydra_integration/hydra_integration_gap_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gap Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/hydra_integration/hydra_integration_master_document/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Master Document
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_2_3_4" id="__nav_3_2_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Components
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_2_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Components
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/hydra_integration/components/stageA/StageA_2D_Adjacency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stage A
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/hydra_integration/components/stageB/StageB_Torsion_Pairwise/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stage B
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/hydra_integration/components/stageC/StageC_3D_Reconstruction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stage C
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/hydra_integration/components/stageD/StageD_Diffusion_Refinement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stage D
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/integration/hydra_integration/components/unified_latent/UnifiedLatentMerger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unified Latent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stage A
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stage A
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageA/StageA_RFold/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageA/RFold_code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RFold Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageA/RFold_paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RFold Paper
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageA/rfold-demo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Demo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageA/stage_a_extra/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Extra Notes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stage B
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stage B
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageB/Stage_B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2" >
        
          
          <label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    TorsionBERT
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    TorsionBERT
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageB/torsionBert/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageB/torsionbert_code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageB/torsionBert_full_paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Paper
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Stage C
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Stage C
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageC/Stage_C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageC/Integrated_RNA_Geometry_and_3D_Reconstruction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Geometry & Reconstruction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageC/Unified, Comprehensive Plan for Integrating MP-NeRF into Stage C.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MP-NeRF Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/stageC/mp_nerf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    MP-NeRF Details
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Unified Latent
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Unified Latent
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/unified_latent/Perceiver_IO/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Perceiver IO
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/Energy_Minimization_%26_Molecular_Dynamics_%28MD%29_for_RNA_Structure_Refinement/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Energy & MD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Testing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/test_time_scaling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Time Scaling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_9" >
        
          
          <label class="md-nav__link" for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Kaggle
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kaggle
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/kaggle_info/kaggle_competition/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Competition
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pipeline/kaggle_info/M2_Plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    M2 Plan
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Advanced Methods
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced Methods
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1_1" id="__nav_4_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    AlphaFold 3
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    AlphaFold 3
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/advanced_methods/af3/AF3_paper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Paper
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/advanced_methods/af3/AlphaFold3_progress/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Progress
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/advanced_methods/af3/Pairwise_Distance_Based_Prediction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Distance Prediction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1_2" >
        
          
          <label class="md-nav__link" for="__nav_4_1_2" id="__nav_4_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Diffusion
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Diffusion
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/advanced_methods/diffusion/s4_diffusion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    S4 Diffusion
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/advanced_methods/diffusion/test_time_scaling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Time Scaling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/advanced_methods/isosteric_substitutions/RNA_isostericity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Isosteric Substitutions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    External Literature
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    External Literature
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/external_lit/2d_structure_prediction_papers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2D Structure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/external_lit/RNA_papers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RNA Papers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Residue Atom Bridging
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Residue Atom Bridging
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/residue_atom_bridging/audit_report/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Audit Report
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/residue_atom_bridging/design_spec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Design Spec
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/residue_atom_bridging/documentation_draft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/residue_atom_bridging/implementation_notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Implementation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/residue_atom_bridging/refactoring_plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Refactoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/residue_atom_bridging/bridging_caveats_guidelines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Guidelines
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Torsion Calculations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Torsion Calculations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/torsion_calculations/torsion_angles_intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/torsion_calculations/Standard_Bond_Lengths_and_Angles_in_RNA_Nucleotides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bond Lengths & Angles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/torsion_calculations/Torsion_Angles_3D_Coordinates_RNA_Structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3D Coordinates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/torsion_calculations/torsion_angle_Latent_Manifold_Representation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Latent Manifold
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#purpose" class="md-nav__link">
    <span class="md-ellipsis">
      
        Purpose
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-hypotheses-evidence" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Hypotheses &amp; Evidence
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Key Hypotheses &amp; Evidence">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#h1-the-current-training-step-only-computes-loss-on-stage-c-outputs-not-on-stage-d-outputs" class="md-nav__link">
    <span class="md-ellipsis">
      
        H1: The current training step only computes loss on Stage C outputs, not on Stage D outputs.
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#h2-stage-d-diffusion-is-not-called-at-all-during-training" class="md-nav__link">
    <span class="md-ellipsis">
      
        H2: Stage D (Diffusion) is not called at all during training.
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#h3-pairformer-stage-b-is-not-trained-as-its-outputs-do-not-contribute-to-the-loss" class="md-nav__link">
    <span class="md-ellipsis">
      
        H3: Pairformer (Stage B) is not trained, as its outputs do not contribute to the loss.
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#h4-torsionbert-is-trained-but-only-indirectly-via-stage-cs-coordinate-reconstruction" class="md-nav__link">
    <span class="md-ellipsis">
      
        H4: TorsionBERT is trained, but only indirectly via Stage Cs coordinate reconstruction.
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#h5-there-is-no-direct-angle-supervision-loss-l_angle-in-the-current-training-step" class="md-nav__link">
    <span class="md-ellipsis">
      
        H5: There is no direct angle supervision loss (L_angle) in the current training step.
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#h6-the-loss-function-used-for-stage-d-is-not-the-correct-denoisingdiffusion-objective" class="md-nav__link">
    <span class="md-ellipsis">
      
        H6: The loss function used for Stage D is not the correct denoising/diffusion objective.
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary Table
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusions-recommendations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusions &amp; Recommendations
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="rna_predict-training-loss-function-hypothesis-driven-analysis">RNA_PREDICT Training &amp; Loss Function: Hypothesis-Driven Analysis</h1>
<p><strong>Date:</strong> 2025-05-03<br />
<strong>Branch:</strong> <code>fix/training-loss-function-implementation</code></p>
<h2 id="purpose">Purpose</h2>
<p>This document systematically analyzes the current state of the training and loss function implementation in the RNA_PREDICT pipeline. The analysis follows a hypothesis-driven approach to confirm or reject key concerns about the pipeline's training signal and gradient flow, based on code inspection and evidence.</p>
<hr />
<h2 id="key-hypotheses-evidence">Key Hypotheses &amp; Evidence</h2>
<h3 id="h1-the-current-training-step-only-computes-loss-on-stage-c-outputs-not-on-stage-d-outputs">H1: The current training step only computes loss on Stage C outputs, not on Stage D outputs.</h3>
<p><strong>Evidence:</strong>
- The <code>training_step</code> method in <code>rna_lightning_module.py</code> computes loss using <code>predicted_coords = output["coords"]</code> (output from Stage C).
- No evidence of Stage D output being used for loss.
- The loss is MSE between these coordinates and ground truth.
<strong>Conclusion:</strong>
- <strong>Accepted.</strong> Loss is only on Stage C outputs.</p>
<h3 id="h2-stage-d-diffusion-is-not-called-at-all-during-training">H2: Stage D (Diffusion) is not called at all during training.</h3>
<p><strong>Evidence:</strong>
- In both <code>forward</code> and <code>training_step</code>, there is no call to <code>self.stageD</code>.
- Stage D is instantiated but not invoked in the forward or training path.
<strong>Conclusion:</strong>
- <strong>Accepted.</strong> Stage D is not called during training.</p>
<h3 id="h3-pairformer-stage-b-is-not-trained-as-its-outputs-do-not-contribute-to-the-loss">H3: Pairformer (Stage B) is not trained, as its outputs do not contribute to the loss.</h3>
<p><strong>Evidence:</strong>
- Pairformer outputs are calculated, but only Stage C output is used for loss.
- No direct or indirect use of Pairformer outputs in the loss computation.
- Gradients would not flow to Pairformer parameters.
<strong>Conclusion:</strong>
- <strong>Accepted.</strong> Pairformer is not being trained.</p>
<h3 id="h4-torsionbert-is-trained-but-only-indirectly-via-stage-cs-coordinate-reconstruction">H4: TorsionBERT is trained, but only indirectly via Stage Cs coordinate reconstruction.</h3>
<p><strong>Evidence:</strong>
- TorsionBERT outputs torsion angles, which are used by Stage C to generate coordinates.
- The loss is on coordinates, so gradients flow back through Stage C to TorsionBERT.
- There is no direct angle supervision.
<strong>Conclusion:</strong>
- <strong>Accepted.</strong> TorsionBERT is trained, but only indirectly.</p>
<h3 id="h5-there-is-no-direct-angle-supervision-loss-l_angle-in-the-current-training-step">H5: There is no direct angle supervision loss (<code>L_angle</code>) in the current training step.</h3>
<p><strong>Evidence:</strong>
- No angle-based loss found in <code>training_step</code>.
- Only coordinate-based MSE loss is present.
<strong>Conclusion:</strong>
- <strong>Accepted.</strong> No direct angle supervision loss is implemented.</p>
<h3 id="h6-the-loss-function-used-for-stage-d-is-not-the-correct-denoisingdiffusion-objective">H6: The loss function used for Stage D is not the correct denoising/diffusion objective.</h3>
<p><strong>Evidence:</strong>
- No diffusion/denoising loss is implemented.
- No noise sampling, no call to Stage D, no diffusion loss logic.
<strong>Conclusion:</strong>
- <strong>Accepted.</strong> Diffusion loss is not implemented.</p>
<hr />
<h2 id="summary-table">Summary Table</h2>
<table>
<thead>
<tr>
<th>Hypothesis</th>
<th>Status</th>
<th>Evidence/Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>H1</td>
<td>Accepted</td>
<td>Loss is only on Stage C output coords</td>
</tr>
<tr>
<td>H2</td>
<td>Accepted</td>
<td>Stage D not called in forward/training_step</td>
</tr>
<tr>
<td>H3</td>
<td>Accepted</td>
<td>Pairformer outputs not used in loss</td>
</tr>
<tr>
<td>H4</td>
<td>Accepted</td>
<td>TorsionBERT trained indirectly via coords</td>
</tr>
<tr>
<td>H5</td>
<td>Accepted</td>
<td>No direct angle loss present</td>
</tr>
<tr>
<td>H6</td>
<td>Accepted</td>
<td>No diffusion loss or Stage D integration</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="conclusions-recommendations">Conclusions &amp; Recommendations</h2>
<ul>
<li>The current training implementation is misaligned with the intended multi-stage pipeline design.</li>
<li>Only TorsionBERT receives a training signal, and only indirectly.</li>
<li>Pairformer and Stage D receive no training signal at all.</li>
<li>No direct angle supervision or diffusion loss is present.</li>
</ul>
<p><strong>Actionable Steps:</strong>
1. Implement direct angle supervision (<code>L_angle</code>).
2. Integrate Stage D into the forward and training path.
3. Implement the correct diffusion loss objective.
4. Ensure gradients flow to all intended components (TorsionBERT, Pairformer, Stage D).
5. Test with debug output and gradient checks after each incremental change.</p>
<h1 id="this-analysis-provides-a-clear-evidence-based-foundation-for-the-required-refactoring-and-implementation-work">This analysis provides a clear, evidence-based foundation for the required refactoring and implementation work.</h1>
<p>Okay, let's systematically break down the training and loss function situation in your <code>RNA_PREDICT</code> pipeline. Your analysis that the current setup might be incorrect is spot-on, particularly given the staged nature and the different model types involved.</p>
<p><strong>Refined Hypothesis:</strong></p>
<p>The current training implementation in <code>RNALightningModule</code> is fundamentally misaligned with the intended pipeline design described in the documentation (internal design docs, TorsionBERT paper, AF3 paper). Specifically:</p>
<ol>
<li>The loss is calculated based on the 3D coordinate output of <strong>Stage C (MP-NeRF)</strong>, not the final output of <strong>Stage D (Diffusion)</strong>.</li>
<li>This results in <strong>Stage D (Diffusion model) and Stage B (Pairformer)</strong> receiving <strong>no training signal (zero gradients)</strong>.</li>
<li><strong>Stage B (TorsionBERT)</strong> is being trained, but <strong>indirectly and suboptimally</strong>, via gradients flowing back through the Stage C geometric reconstruction, rather than through direct angle supervision or via gradients from the final Stage D output.</li>
<li>The current MSE loss on coordinates is <strong>inappropriate</strong> for training the Stage D diffusion model, which requires a specific denoising objective.</li>
</ol>
<p>This discrepancy means the core components responsible for global context (Pairformer) and final structure refinement (Diffusion) are not learning, and TorsionBERT is learning from a potentially noisy, indirect signal.</p>
<p><strong>Detailed Analysis:</strong></p>
<ol>
<li>
<p><strong>Analysis of <code>RNALightningModule</code> Training Code:</strong></p>
<ul>
<li><strong><code>forward</code> method:</strong> Executes Stages A, B (Torsion &amp; Pairformer), and C sequentially. It produces <code>coords</code> from Stage C. <strong>Crucially, it does <em>not</em> execute <code>self.stageD</code> (ProtenixDiffusionManager).</strong></li>
<li><strong><code>training_step</code> method:</strong><ul>
<li>Calls <code>self.forward(batch)</code>.</li>
<li>Extracts <code>predicted_coords = output["coords"]</code> (output of Stage C).</li>
<li>Calculates <code>loss = MSE(predicted_coords, real_target_coords)</code>.</li>
<li>The complex masking logic attempts to align atoms for this Stage C vs Ground Truth comparison.</li>
<li>It checks <code>predicted_coords.requires_grad</code>, confirming the <em>intent</em> to train upstream models.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Analysis of Gradient Flow:</strong></p>
<ul>
<li>Loss originates from Stage C's output MSE.</li>
<li>Gradients flow backward: <code>Loss -&gt; predicted_coords</code>.</li>
<li><strong>Stage C (MP-NeRF):</strong> Since it's differentiable geometric operations based on input angles (<code>rna_predict.pipeline.stageC.mp_nerf.rna.rna_fold</code>), gradients flow <em>through</em> it to its input (<code>torsion_angles</code>). As stated, Stage C has no trainable parameters, so it's just a conduit.</li>
<li><strong>Stage B (TorsionBERT):</strong> Receives gradients because <code>torsion_angles</code> (its output) is the input to the differentiable Stage C. <strong>It IS being trained</strong>, but the signal is "produce angles that, after MP-NeRF reconstruction, match the ground truth 3D coords". This is indirect.</li>
<li><strong>Stage B (Pairformer):</strong> Its outputs (<code>s_embeddings</code>, <code>z_embeddings</code>) are calculated but <strong>do not contribute to the <code>predicted_coords</code> used in the loss</strong>. They only feed the <code>latent_merger</code>, whose output is also ignored by the loss. <strong>Pairformer is NOT being trained.</strong></li>
<li><strong>Stage D (Diffusion):</strong> The <code>self.stageD</code> module is <strong>never called</strong> in the training forward path. <strong>Stage D is NOT being trained.</strong></li>
<li><strong>Stage A (RFold):</strong> No trainable parameters, not involved in loss. Not trained.</li>
</ul>
</li>
<li>
<p><strong>Cross-Referencing with Documentation:</strong></p>
<ul>
<li><strong>TorsionBERT Paper (<code>torsionBert_full_paper.md</code>):</strong><ul>
<li>Focus: Predicting angles accurately. Metrics: MCQ, MAE on angles.</li>
<li>Training: Direct supervision comparing predicted angles (or sin/cos) to ground truth angles.</li>
<li><em>Discrepancy:</em> Current loss trains indirectly via 3D coords, lacking direct angle supervision.</li>
</ul>
</li>
<li><strong>AlphaFold 3 Paper (<code>AF3_paper.md</code> Supplement):</strong><ul>
<li><em>Pairformer (Trunk):</em> Produces <code>s_i</code>, <code>z_ij</code> to condition the Diffusion module. Trained <em>implicitly</em> via gradients from the final diffusion loss (AF3 Eq 15).</li>
<li><em>Discrepancy:</em> Current setup provides <strong>no gradient</strong> to Pairformer.</li>
<li><em>Diffusion Module:</em> Trained using a denoising objective (AF3 Eq 6 - weighted MSE, LDDT loss, etc.) on noisy coordinates, conditioned on trunk embeddings.</li>
<li><em>Discrepancy:</em> Current loss (MSE on Stage C output) is fundamentally different. Stage D isn't run.</li>
</ul>
</li>
<li><strong>Internal Design Docs (<code>Integrated_RNA_3D...</code>, <code>full_pipeline_spec...</code>, <code>core_framework...</code>):</strong><ul>
<li>Flow: Stages A/B -&gt; Merger -&gt; Stage D -&gt; Final Coords.</li>
<li>Combined Loss: Explicitly mention <code>L_3D</code> (on Stage D output) + <code>L_angle</code> (for TorsionBERT) + optional <code>L_pair</code>.</li>
<li><em>Discrepancy:</em> Current loss is on Stage C output, lacks Stage D integration, and lacks <code>L_angle</code>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Conclusion Confirmation:</strong></p>
<ul>
<li>The current training loss setup is significantly flawed. It trains only TorsionBERT, and does so indirectly. It completely ignores Pairformer and the entire Stage D Diffusion model, which are critical components according to the design documents and underlying model papers.</li>
</ul>
</li>
</ol>
<p><strong>Actionable Recommendations (Refined Implementation Plan):</strong></p>
<p>To correctly train the intended pipeline, the <code>RNALightningModule</code> needs substantial refactoring, primarily in the <code>training_step</code>.</p>
<p><strong>Phase 1: Prerequisites &amp; Direct Angle Supervision</strong></p>
<ol>
<li>
<p><strong>Enable Ground Truth Angle Loading:</strong></p>
<ul>
<li><strong>File:</strong> <code>rna_predict/conf/data/default.yaml</code><ul>
<li><strong>Action:</strong> Set <code>load_ang: true</code>.</li>
<li><strong>Action:</strong> Ensure paths/patterns for loading angle data are correctly configured if not derivable from <code>index_csv</code>.</li>
</ul>
</li>
<li><strong>File:</strong> <code>rna_predict/dataset/loader.py</code> (<code>RNADataset</code>)<ul>
<li><strong>Action:</strong> Implement <code>_load_angles</code> to read angle data (e.g., from <code>.pt</code>, <code>.npy</code>). Handle missing data.</li>
<li><strong>Action:</strong> In <code>__getitem__</code>, call <code>_load_angles</code> and add the tensor as <code>"angles_true"</code> to the sample dictionary. Ensure correct padding/dtype.</li>
</ul>
</li>
<li><strong>File:</strong> <code>rna_predict/dataset/collate.py</code> (<code>rna_collate_fn</code>)<ul>
<li><strong>Action:</strong> Ensure the collate function correctly handles and batches the <code>"angles_true"</code> tensor.</li>
</ul>
</li>
<li><strong>Verification:</strong> Load a batch and confirm <code>"angles_true"</code> exists with shape <code>[B, N, 7]</code> (or similar) and correct dtype/device.</li>
</ul>
</li>
<li>
<p><strong>Implement Direct Angle Loss (<code>L_angle</code>) in <code>training_step</code>:</strong></p>
<ul>
<li><strong>File:</strong> <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule</code>)</li>
<li><strong>Action:</strong> Inside <code>training_step</code>, after <code>output = self.forward(batch)</code>:<ul>
<li><code>predicted_angles_sincos = output["torsion_angles"]</code> # Shape [B, N, 14]</li>
<li><code>true_angles_rad = batch["angles_true"]</code> # Shape [B, N, 7]</li>
<li>Implement/import <code>angles_rad_to_sin_cos(true_angles_rad)</code> -&gt; <code>true_angles_sincos</code> # Shape [B, N, 14]</li>
<li><code>loss_angle = F.mse_loss(predicted_angles_sincos, true_angles_sincos)</code> (apply masking if needed based on sequence length).</li>
<li>Store <code>loss_angle</code>.</li>
</ul>
</li>
<li><strong>Verification:</strong> Temporarily return <code>{"loss": loss_angle}</code>. Train 1 step. Check <code>self.stageB_torsion</code> parameters have non-None <code>.grad</code>.</li>
</ul>
</li>
</ol>
<p><strong>Phase 2: Integrating Stage D into Training</strong></p>
<ol>
<li>
<p><strong>Prepare Inputs for Stage D within <code>training_step</code>:</strong></p>
<ul>
<li><strong>File:</strong> <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule</code>)</li>
<li><strong>Action:</strong> Gather inputs needed by <code>self.stageD.forward</code> (or a dedicated train method).<ul>
<li><code>coords_true = batch["coords_true"]</code> # Shape [B, N_atom, 3]</li>
<li>Sample noise level <code>sigma_t</code> (shape <code>[B]</code>) based on a schedule (e.g., AF3's exponential or simpler linear).</li>
<li>Generate noise <code>epsilon</code> (shape like <code>coords_true</code>).</li>
<li><code>coords_noisy = coords_true + epsilon * sigma_t.view(-1, 1, 1)</code>.</li>
<li>Retrieve Stage B outputs: <code>s_embeddings</code> (<code>[B, N_res, C_s]</code>), <code>z_embeddings</code> (<code>[B, N_res, N_res, C_z]</code>).</li>
<li><strong>(Bridging Required):</strong> Bridge residue-level <code>s_embeddings</code> (and potentially <code>z_embeddings</code>) to atom-level using <code>rna_predict.utils.tensor_utils.embedding.residue_to_atoms</code> and <code>batch["atom_to_token_idx"]</code>. Let the result be <code>s_embeddings_atom</code>, <code>z_embeddings_atom</code>. This is critical if Stage D expects atom-level conditioning.</li>
<li><strong>(Optional Merger):</strong> If using <code>self.latent_merger</code>, feed it the necessary (potentially bridged) embeddings, angles, adjacency to get <code>unified_latent</code>. Ensure its output level (residue/atom) matches Stage D's expectation.</li>
<li>Define <code>conditioning_signal</code> (e.g., <code>s_embeddings_atom</code>, <code>z_embeddings_atom</code>, or <code>unified_latent</code>).</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Execute Stage D Training Step:</strong></p>
<ul>
<li><strong>File:</strong> <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule</code>)</li>
<li><strong>Action:</strong> Call <code>self.stageD</code>'s forward/training method.<ul>
<li><code>stage_d_pred = self.stageD(coords_noisy=coords_noisy, conditioning=conditioning_signal, noise_level=sigma_t, **other_stageD_args)</code></li>
</ul>
</li>
<li><strong>Verification:</strong> Check input/output shapes and types. Ensure no runtime errors.</li>
</ul>
</li>
<li>
<p><strong>Implement Diffusion Loss (<code>L_diffusion</code>)</strong>:</p>
<ul>
<li><strong>File:</strong> <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule</code>)</li>
<li><strong>Action:</strong> Calculate loss based on <code>stage_d_pred</code>.<ul>
<li><strong>If <code>stage_d_pred</code> is predicted noise <code>\hat{\epsilon}</code>:</strong><ul>
<li><code>loss_diffusion = F.mse_loss(stage_d_pred, epsilon)</code> (apply masking).</li>
</ul>
</li>
<li><strong>If <code>stage_d_pred</code> is predicted denoised coords <code>\hat{x}_0</code> (like AF3):</strong><ul>
<li>Requires implementing <code>weighted_rigid_align</code> (Algo 28) and <code>SmoothLDDTLoss</code> (Algo 27).</li>
<li><code>aligned_coords_true = weighted_rigid_align(coords_true, stage_d_pred, weights)</code></li>
<li><code>loss_mse = weighted_mse(stage_d_pred, aligned_coords_true, weights)</code></li>
<li><code>loss_lddt = SmoothLDDTLoss(stage_d_pred, aligned_coords_true)</code></li>
<li><code>loss_diffusion = weight_factor * (loss_mse + w_lddt * loss_lddt)</code> (weight_factor depends on <code>sigma_t</code> per AF3 Eq 6).</li>
<li><em>Recommendation:</em> Start with the simpler noise prediction objective if possible, unless Stage D is explicitly designed for coordinate prediction.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Verification:</strong> Check <code>loss_diffusion</code> is scalar. Temporarily return <code>{"loss": loss_diffusion}</code>. Train 1 step. Verify gradients flow to <code>self.stageD</code> parameters <em>and</em> back to the conditioning parameters (Pairformer, TorsionBERT, Merger).</li>
</ul>
</li>
</ol>
<p><strong>Phase 3: Final Integration</strong></p>
<ol>
<li>
<p><strong>Combine and Log Losses:</strong></p>
<ul>
<li><strong>File:</strong> <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule</code>)</li>
<li><strong>Action:</strong> Define loss weights in config (e.g., <code>cfg.training.w_diffusion</code>, <code>cfg.training.w_angle</code>).</li>
<li><strong>Action:</strong> Calculate <code>total_loss = cfg.training.w_diffusion * loss_diffusion + cfg.training.w_angle * loss_angle</code>.</li>
<li><strong>Action:</strong> Use <code>self.log(...)</code> to log <code>total_loss</code>, <code>loss_diffusion</code>, <code>loss_angle</code>.</li>
<li><strong>Action:</strong> Return <code>{"loss": total_loss}</code>.</li>
</ul>
</li>
<li>
<p><strong>Configuration &amp; Dimension Review:</strong></p>
<ul>
<li><strong>Files:</strong> <code>rna_predict/conf/**</code></li>
<li><strong>Action:</strong> Systematically ensure all embedding dimensions (<code>c_s</code>, <code>c_z</code>, <code>c_atom</code>, <code>num_angles</code>, merger dims, Stage D conditioning dims) are consistent across stage configurations and the <code>config_schema.py</code>. Pay close attention to residue-vs-atom level dimensions during bridging.</li>
</ul>
</li>
<li>
<p><strong>Testing Strategy:</strong></p>
<ul>
<li><strong>Unit Tests:</strong> For angle conversion, loss calculations (diffusion, angle), merger.</li>
<li><strong>Integration Test (<code>test_lightning_trainer.py</code>):</strong> Train for a few steps on 1-2 samples. Assert non-None gradients for parameters in TorsionBERT (LoRA), Pairformer (LoRA), and Stage D.</li>
<li><strong>Monitor Training:</strong> Use TensorBoard/W&amp;B to watch loss components decrease on a small dataset. Use loss weights to isolate components if debugging is needed.</li>
</ul>
</li>
</ol>
<h1 id="this-detailed-plan-addresses-the-identified-discrepancies-and-provides-a-concrete-path-to-implement-a-correct-and-effective-training-loop-for-your-multi-stage-rna-prediction-pipeline-the-most-complex-parts-will-be-the-residue-to-atom-bridging-for-stage-d-conditioning-and-implementing-the-chosen-diffusion-loss-objective-accurately">This detailed plan addresses the identified discrepancies and provides a concrete path to implement a correct and effective training loop for your multi-stage RNA prediction pipeline. The most complex parts will be the residue-to-atom bridging for Stage D conditioning and implementing the chosen diffusion loss objective accurately.</h1>
<p>Okay, let's perform a detailed, critical deep dive into <strong>Phase 1: Enable Ground Truth Angle Loading</strong> of the proposed plan. This is a foundational step, and getting the data loading right is crucial for implementing the direct angle loss later.</p>
<p><strong>Goal of Phase 1:</strong> Modify the data pipeline (<code>RNADataset</code> and <code>rna_collate_fn</code>) to reliably load, process (pad/truncate), and batch ground truth torsion angles, making them available as <code>batch["angles_true"]</code> with the correct shape, dtype, and device in the <code>RNALightningModule.training_step</code>.</p>
<hr />
<p><strong>1. File: <code>rna_predict/conf/data/default.yaml</code></strong></p>
<ul>
<li>
<p><strong>Action 1.1: Enable Angle Loading Flag</strong></p>
<ul>
<li><strong>Code Change:</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># rna_predict/conf/data/default.yaml</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1"># ... (other keys) ...</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nt">load_adj</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="nt">load_ang</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">   </span><span class="c1"># &lt;&lt;&lt; CHANGE THIS LINE from false to true</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="c1"># ... (other keys like coord_fill_value, coord_dtype) ...</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1"># Optional: Add flag for detailed batch inspection during debugging</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nt">debug_inspect_batch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># Set to true via CLI or test config to log first batch details</span>
</code></pre></div></li>
<li><strong>Rationale:</strong> This boolean flag acts as a switch for the <code>RNADataset</code> to activate the angle loading logic. It allows flexibility to train with or without angle supervision without changing code.</li>
<li><strong>Critical Consideration:</strong> This flag <em>only</em> enables the <em>attempt</em> to load angles. It doesn't guarantee the data exists or is correctly formatted.</li>
</ul>
</li>
<li>
<p><strong>Action 1.2: Define Angle Data Location and Format Strategy</strong></p>
<ul>
<li><strong>Strategy Decision:</strong> Assume angle data for a structure (e.g., <code>data_root/1abc.cif</code>) is stored in a corresponding file (e.g., <code>data_root/1abc.pt</code>). This requires a consistent naming convention.<ul>
<li><strong>File Extension:</strong> Assume <code>.pt</code> (PyTorch tensor file).</li>
<li><strong>Data Format:</strong> Assume the <code>.pt</code> file directly contains a <code>torch.Tensor</code>.</li>
<li><strong>Tensor Shape:</strong> Assume shape <code>[L, 7]</code>, where <code>L</code> is the number of residues in the sequence, and 7 corresponds to the standard torsions (, , , , , , ).</li>
<li><strong>Units:</strong> Assume angles are stored in <strong>radians</strong>. This is the standard for trigonometric functions in PyTorch/NumPy.</li>
<li><strong>Dtype:</strong> Assume <code>torch.float32</code>.</li>
</ul>
</li>
<li><strong>Configuration Impact:</strong> <em>No new configuration keys are needed immediately</em> if this convention is followed. The existing <code>root_dir</code> and the file path derived from <code>index_csv</code> (e.g., <code>row['filepath']</code> or similar) will be used to construct the angle file path.</li>
<li><strong>Alternative Strategies (If needed later):</strong><ul>
<li>Add <code>data.angle_dir</code> key if angles are in a separate directory.</li>
<li>Add <code>data.angle_suffix</code> key if the extension isn't <code>.pt</code>.</li>
<li>Add a column like <code>angle_filepath</code> to <code>index_csv</code>.</li>
<li>Store angles within a larger <code>.pt</code> or <code>.hdf5</code> file containing multiple data types per structure.</li>
</ul>
</li>
<li><strong>Documentation:</strong> This chosen strategy (same base name, <code>.pt</code> extension, <code>[L, 7]</code> shape, radians) <em>must</em> be clearly documented for anyone preparing the training data.</li>
</ul>
</li>
</ul>
<hr />
<p><strong>2. File: <code>rna_predict/dataset/loader.py</code> (<code>RNADataset</code>)</strong></p>
<ul>
<li>
<p><strong>Action 2.1: Imports</strong></p>
<ul>
<li><strong>Code Change:</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span> <span class="c1"># Ensure Path is imported</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span> <span class="c1"># Add Optional for type hinting</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1"># ... other imports ...</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p><strong>Action 2.2: Implement <code>_load_angles</code> Method</strong></p>
<ul>
<li><strong>Code Implementation:</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Inside RNADataset class</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">_get_structure_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to consistently get the structure filepath.&quot;&quot;&quot;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="c1"># !! ADAPT THIS based on your actual index_csv structure !!</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="c1"># Example 1: If CSV has a &#39;filepath&#39; column</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="k">if</span> <span class="s1">&#39;filepath&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">]):</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>        <span class="n">file_path_str</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">]</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="c1"># Example 2: If CSV has &#39;pdb_id&#39; and &#39;chain&#39; (e.g., &quot;1abc_A&quot;)</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="k">elif</span> <span class="s1">&#39;target_id&#39;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;target_id&#39;</span><span class="p">]):</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>         <span class="c1"># Assuming target_id might be like &quot;PDBID_CHAIN&quot; or just &quot;PDBID&quot;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>         <span class="n">pdb_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;target_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>         <span class="c1"># Assuming extension is .cif, could be .pdb</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>         <span class="n">file_path_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pdb_id</span><span class="si">}</span><span class="s2">.cif&quot;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot determine structure file path from row: </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path_str</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">file_path</span> <span class="c1"># Assumes root_dir is absolute or relative to CWD</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>         <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structure file not found at resolved path: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="k">return</span> <span class="n">file_path</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">_load_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="sd">    Loads ground truth torsion angles from a .pt file based on the</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="sd">    structure file path derived from the row.</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="sd">    Assumes angle file has the same base name as structure file but with .pt extension.</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="sd">    Returns None if file not found or data is invalid.</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>    <span class="n">angle_path</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize for error logging</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="n">structure_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_structure_filepath</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>        <span class="n">angle_path</span> <span class="o">=</span> <span class="n">structure_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pt&quot;</span><span class="p">)</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">angle_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Angle file not found for </span><span class="si">{</span><span class="n">structure_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> at expected location: </span><span class="si">{</span><span class="n">angle_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>        <span class="c1"># Load the tensor data</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="n">angles_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">angle_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span> <span class="c1"># Load to CPU first</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>        <span class="c1"># --- Data Validation ---</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angles_data</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid data type in angle file </span><span class="si">{</span><span class="n">angle_path</span><span class="si">}</span><span class="s2">. Expected torch.Tensor, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">angles_data</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>        <span class="k">if</span> <span class="n">angles_data</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dimensions in angle file </span><span class="si">{</span><span class="n">angle_path</span><span class="si">}</span><span class="s2">. Expected 2D tensor [L, num_angles], got </span><span class="si">{</span><span class="n">angles_data</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="si">}</span><span class="s2">D.&quot;</span><span class="p">)</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>        <span class="n">num_angles_loaded</span> <span class="o">=</span> <span class="n">angles_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>        <span class="c1"># Check if number of angles is reasonable (e.g., 7 standard, maybe more if pseudo included)</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>        <span class="k">if</span> <span class="n">num_angles_loaded</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span> <span class="c1"># Allow for more than 7 if pseudo-torsions are included</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected number of angles (</span><span class="si">{</span><span class="n">num_angles_loaded</span><span class="si">}</span><span class="s2">) in </span><span class="si">{</span><span class="n">angle_path</span><span class="si">}</span><span class="s2">. Expected at least 7. Using loaded data.&quot;</span><span class="p">)</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>             <span class="c1"># Decide if this should be an error or just a warning</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>        <span class="c1"># Length check will happen in __getitem__ after sequence is loaded</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>        <span class="c1"># Ensure dtype is float32</span>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>        <span class="k">return</span> <span class="n">angles_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>         <span class="c1"># This is handled by _get_structure_filepath now, but keep as fallback</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structure file error for row </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>         <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading or validating angles for </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">angle_path</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">angle_path</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;unknown path&#39;</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></li>
<li><strong>Critical Considerations:</strong><ul>
<li>Robust Path Finding: The <code>_get_structure_filepath</code> needs to correctly interpret your <code>index_csv</code> to find the base path. The example provided covers common scenarios but might need adjustment. Ensure it correctly resolves relative paths using <code>self.root_dir</code>.</li>
<li>Validation: The checks for tensor type and dimensions are crucial. Decide how strictly to enforce the number of columns (e.g., exactly 7, or at least 7).</li>
<li>Error Logging: Provide informative logs, especially when files are missing or data is invalid. Include <code>exc_info=self.verbose</code> for detailed tracebacks during debugging.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Action 2.3: Modify <code>__getitem__</code></strong></p>
<ul>
<li><strong>Code Implementation:</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Inside RNADataset.__getitem__:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="n">item_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="c1"># For logging</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="c1"># --- Load Sequence (Assume _load_sequence exists) ---</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_sequence</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="k">if</span> <span class="n">sequence</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load sequence for item </span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">. Skipping sample.&quot;</span><span class="p">)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>         <span class="c1"># Returning an empty dict or raising an error might be necessary depending on DataLoader robustness</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>         <span class="k">return</span> <span class="p">{}</span> <span class="c1"># Or raise appropriate error</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="n">L_res</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="c1"># --- Load Coords &amp; Mask (Assume _load_coords exists) ---</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>    <span class="n">coords_true</span><span class="p">,</span> <span class="n">atom_mask</span><span class="p">,</span> <span class="n">L_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_coords</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="c1"># Assume returns tuple</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="k">if</span> <span class="n">coords_true</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">atom_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load coordinates/mask for item </span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">. Skipping sample.&quot;</span><span class="p">)</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>         <span class="k">return</span> <span class="p">{}</span> <span class="c1"># Or raise</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="c1"># --- Load Angles (Conditional) ---</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="n">angles_true_loaded</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ang</span><span class="p">:</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>        <span class="n">angles_true_loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_angles</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>    <span class="c1"># --- Process Angles (Validation, Placeholder Creation, Padding) ---</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>    <span class="n">angles_true_processed</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>    <span class="n">expected_angle_dim</span> <span class="o">=</span> <span class="mi">7</span> <span class="c1"># Define expected dimension</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>    <span class="k">if</span> <span class="n">angles_true_loaded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>        <span class="c1"># Validate length against sequence length</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>        <span class="k">if</span> <span class="n">angles_true_loaded</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">L_res</span><span class="p">:</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Angle length mismatch for </span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">: Angles(</span><span class="si">{</span><span class="n">angles_true_loaded</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) != Sequence(</span><span class="si">{</span><span class="n">L_res</span><span class="si">}</span><span class="s2">). Using zero placeholder.&quot;</span><span class="p">)</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>            <span class="n">angles_true_processed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L_res</span><span class="p">,</span> <span class="n">expected_angle_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>            <span class="c1"># Use loaded angles, ensure correct dim if needed</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>            <span class="k">if</span> <span class="n">angles_true_loaded</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">expected_angle_dim</span><span class="p">:</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Angle dim mismatch for </span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">: Expected </span><span class="si">{</span><span class="n">expected_angle_dim</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">angles_true_loaded</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">. Slicing/Padding last dim.&quot;</span><span class="p">)</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>                 <span class="c1"># Slice or pad the feature dimension (dim 1)</span>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>                 <span class="k">if</span> <span class="n">angles_true_loaded</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">expected_angle_dim</span><span class="p">:</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>                      <span class="n">angles_true_processed</span> <span class="o">=</span> <span class="n">angles_true_loaded</span><span class="p">[:,</span> <span class="p">:</span><span class="n">expected_angle_dim</span><span class="p">]</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>                 <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>                      <span class="n">pad_needed</span> <span class="o">=</span> <span class="n">expected_angle_dim</span> <span class="o">-</span> <span class="n">angles_true_loaded</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>                      <span class="n">padding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L_res</span><span class="p">,</span> <span class="n">pad_needed</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>                      <span class="n">angles_true_processed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">angles_true_loaded</span><span class="p">,</span> <span class="n">padding</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>                 <span class="n">angles_true_processed</span> <span class="o">=</span> <span class="n">angles_true_loaded</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># Ensure dtype</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_ang</span><span class="p">:</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>         <span class="c1"># Loading was enabled but failed or file not found</span>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load angles for </span><span class="si">{</span><span class="n">item_id</span><span class="si">}</span><span class="s2">. Using zero placeholder.&quot;</span><span class="p">)</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>         <span class="n">angles_true_processed</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L_res</span><span class="p">,</span> <span class="n">expected_angle_dim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>    <span class="c1"># else: load_ang is False, angles_true_processed remains None</span>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>    <span class="c1"># Apply padding/truncation to max_res</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>    <span class="k">if</span> <span class="n">angles_true_processed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>        <span class="k">if</span> <span class="n">L_res</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_res</span><span class="p">:</span>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>            <span class="n">angles_true_final</span> <span class="o">=</span> <span class="n">angles_true_processed</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_res</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>        <span class="k">elif</span> <span class="n">L_res</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_res</span><span class="p">:</span>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>            <span class="n">pad_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_res</span> <span class="o">-</span> <span class="n">L_res</span>
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>            <span class="n">padding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pad_len</span><span class="p">,</span> <span class="n">angles_true_processed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>            <span class="n">angles_true_final</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">angles_true_processed</span><span class="p">,</span> <span class="n">padding</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>            <span class="n">angles_true_final</span> <span class="o">=</span> <span class="n">angles_true_processed</span>
<a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>         <span class="n">angles_true_final</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Keep as None if load_ang was false</span>
<a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>
<a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>    <span class="c1"># --- Construct Final Sample Dictionary ---</span>
<a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a>    <span class="n">sample</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a>        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">item_id</span><span class="p">,</span>
<a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>        <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">sequence</span><span class="p">,</span> <span class="c1"># Already loaded &amp; processed</span>
<a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a>        <span class="s1">&#39;coords_true&#39;</span><span class="p">:</span> <span class="n">coords_true</span><span class="p">,</span> <span class="c1"># Already loaded &amp; processed</span>
<a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>        <span class="s1">&#39;atom_mask&#39;</span><span class="p">:</span> <span class="n">atom_mask</span><span class="p">,</span> <span class="c1"># Already loaded &amp; processed</span>
<a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>        <span class="c1"># ... include ALL other keys needed by the model/collate_fn ...</span>
<a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a>        <span class="c1"># &#39;atom_to_token_idx&#39;: ...,</span>
<a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>        <span class="c1"># &#39;ref_element&#39;: ...,</span>
<a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>        <span class="c1"># &#39;ref_atom_name_chars&#39;: ...,</span>
<a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a>        <span class="c1"># &#39;residue_indices&#39;: ... # Add this if needed</span>
<a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a>    <span class="p">}</span>
<a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a>
<a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>    <span class="k">if</span> <span class="n">angles_true_final</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>         <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angles_true_final</span>
<a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a>
<a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>    <span class="c1"># Example: Add residue_indices if not already loaded</span>
<a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a>    <span class="k">if</span> <span class="s1">&#39;residue_indices&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample</span> <span class="ow">and</span> <span class="s1">&#39;atom_to_token_idx&#39;</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">:</span>
<a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a>         <span class="c1"># Assuming atom_to_token_idx maps atom index to residue index</span>
<a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>         <span class="c1"># This is a placeholder - adapt based on your actual data structure</span>
<a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a>         <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;residue_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;atom_to_token_idx&#39;</span><span class="p">]</span>
<a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a>
<a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a>    <span class="k">return</span> <span class="n">sample</span>
</code></pre></div></li>
<li><strong>Critical Considerations:</strong><ul>
<li>Order of Operations: Ensure <code>L_res</code> (sequence length) is known <em>before</em> creating placeholder tensors or performing length validation for angles.</li>
<li>Placeholder Strategy: Using <code>torch.zeros</code> as a placeholder for missing/failed loads is common, but relies on the loss function correctly handling masking (e.g., using an attention mask derived from sequence length). Alternatively, samples with missing crucial data could be skipped entirely.</li>
<li>Dimension Handling: Explicitly check and handle potential mismatches in the number of angles (dimension 1) if your data source might vary.</li>
<li>Completeness: Ensure <em>all</em> keys required by the <code>rna_collate_fn</code> and the model are present in the final <code>sample</code> dictionary.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr />
<p><strong>3. File: <code>rna_predict/dataset/collate.py</code> (<code>rna_collate_fn</code>)</strong></p>
<ul>
<li><strong>Action 3.1: Add Handling for <code>angles_true</code> Key</strong><ul>
<li><strong>Code Implementation:</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn.utils.rnn</span><span class="w"> </span><span class="kn">import</span> <span class="n">pad_sequence</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">rna_collate_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">debug_logging</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="n">collated_batch</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="c1"># Determine keys present in the first sample to handle optional keys</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="k">return</span> <span class="p">{}</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="n">sample_keys</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="c1"># Keys expected to be stacked (typically already padded in dataset)</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">keys_to_stack</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;coords_true&#39;</span><span class="p">,</span> <span class="s1">&#39;atom_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;angles_true&#39;</span><span class="p">]</span> <span class="c1"># Add angles_true here</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="c1"># Keys needing padding (if variable length in dataset, less common now)</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="n">keys_to_pad</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="c1"># Keys to collect into lists</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="n">keys_to_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence&#39;</span><span class="p">]</span> <span class="c1"># Add other non-tensor keys</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sample_keys</span><span class="p">:</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_stack</span><span class="p">:</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>                <span class="c1"># Check if all items have this key and it&#39;s a tensor</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">):</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>                     <span class="n">tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>                     <span class="c1"># Check if shapes match before stacking (common error source)</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>                     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>                         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collate Error: Inconsistent shapes for key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;. Shapes: </span><span class="si">{</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">tensors</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>                         <span class="n">collated_batch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Or raise error</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>                         <span class="k">continue</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>                     <span class="n">collated_batch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collate Warning: Key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; missing or not a tensor in some batch items. Skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>                     <span class="n">collated_batch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error stacking key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">debug_logging</span><span class="p">)</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>                <span class="n">collated_batch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_pad</span><span class="p">:</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>             <span class="c1"># Add padding logic here if needed</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>             <span class="k">pass</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_to_list</span><span class="p">:</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>             <span class="n">collated_batch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>        <span class="c1"># Handle other keys if necessary, or ignore them</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>        <span class="c1"># else:</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>        <span class="c1">#    if debug_logging: logger.debug(f&quot;Collate: Ignoring key &#39;{key}&#39;&quot;)</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>    <span class="c1"># --- Add Debug Logging for final batch shapes ---</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>    <span class="k">if</span> <span class="n">debug_logging</span><span class="p">:</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Final Collated Batch Shapes/Types ---&quot;</span><span class="p">)</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>         <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">collated_batch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key: &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, Shape: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Dtype: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, Device: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>             <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key: &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, Type: list, Length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>             <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key: &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;------------------------------------------&quot;</span><span class="p">)</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>    <span class="k">return</span> <span class="n">collated_batch</span>
</code></pre></div></li>
<li><strong>Critical Considerations:</strong><ul>
<li>Shape Consistency: The most common failure in collation is attempting to stack tensors of different shapes. The added check <code>len(set(t.shape for t in tensors)) &gt; 1</code> helps catch this. This relies on the <code>RNADataset</code> correctly padding/truncating all <code>angles_true</code> tensors to <code>[max_res, 7]</code>.</li>
<li>Handling Missing Keys: The code now checks if the key exists and is a tensor <em>before</em> attempting to stack, logging a warning if it's inconsistent across the batch.</li>
<li>Completeness: Ensure the collation handles <em>all</em> necessary keys from the dataset samples.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr />
<p><strong>4. Verification Plan:</strong></p>
<ul>
<li>
<p><strong>Setup:</strong></p>
<ul>
<li>Create a <code>test_data</code> directory.</li>
<li>Inside, create <code>test_index.csv</code> with at least two rows pointing to structure files:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>id,filepath
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>sample1,test_data/sample1.pdb
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>sample2,test_data/sample2.cif
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a># Add a row that might lack an angle file if testing error handling
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a># sample3,test_data/sample3.pdb
</code></pre></div></li>
<li>Create dummy <code>sample1.pdb</code> (e.g., 10 residues) and <code>sample2.cif</code> (e.g., 20 residues). Exact content doesn't matter much, just needs to be parsable by your <code>_load_coords</code> / <code>_load_sequence</code>.</li>
<li>Create <code>sample1.pt</code> containing <code>torch.randn(10, 7, dtype=torch.float32)</code>.</li>
<li>Create <code>sample2.pt</code> containing <code>torch.randn(20, 7, dtype=torch.float32)</code>.</li>
<li><em>Do not</em> create <code>sample3.pt</code> if testing missing file handling.</li>
<li>Create <code>rna_predict/conf/test_load_angles.yaml</code>:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="c1"># Add minimal model configs ONLY if RNADataset depends on them</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="c1"># - model: ...</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="nt">data</span><span class="p">:</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="nt">index_csv</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_data/test_index.csv</span><span class="w"> </span><span class="c1"># Relative to where test script runs</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">  </span><span class="nt">root_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./</span><span class="w"> </span><span class="c1"># Assumes test script runs from project root</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">  </span><span class="nt">load_ang</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">  </span><span class="nt">max_res</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span><span class="w"> </span><span class="c1"># Choose a value &gt; largest L (e.g., 20)</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">  </span><span class="nt">batch_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">  </span><span class="nt">num_workers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"> </span><span class="c1"># CRITICAL for debugging</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">  </span><span class="nt">verbose</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># Enable dataset verbose logging</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">  </span><span class="nt">debug_inspect_batch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># Enable detailed batch logging in train.py (if used)</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="c1"># Add minimal training config if needed by LightningModule</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="c1"># training:</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="c1">#   w_diffusion: 1.0</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="c1">#   w_angle: 0.1</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p><strong>Execution Script (<code>tests/integration/test_angle_loading.py</code>):</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">hydra</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">omegaconf</span><span class="w"> </span><span class="kn">import</span> <span class="n">DictConfig</span><span class="p">,</span> <span class="n">OmegaConf</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rna_predict.dataset.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">RNADataset</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rna_predict.dataset.collate</span><span class="w"> </span><span class="kn">import</span> <span class="n">rna_collate_fn</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="c1"># Assuming this test runs from the project root directory</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="n">CONFIG_PATH</span> <span class="o">=</span> <span class="s2">&quot;../rna_predict/conf&quot;</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="n">CONFIG_NAME</span> <span class="o">=</span> <span class="s2">&quot;test_load_angles.yaml&quot;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">)</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">hydra_config</span><span class="p">():</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the Hydra configuration.&quot;&quot;&quot;</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="k">with</span> <span class="n">hydra</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="n">CONFIG_PATH</span><span class="p">,</span> <span class="n">version_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="n">cfg</span> <span class="o">=</span> <span class="n">hydra</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="n">CONFIG_NAME</span><span class="p">)</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>    <span class="c1"># Resolve paths relative to original CWD if needed by dataset</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>    <span class="c1"># Example: cfg.data.index_csv = os.path.join(hydra.utils.get_original_cwd(), cfg.data.index_csv)</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>    <span class="c1"># Example: cfg.data.root_dir = os.path.join(hydra.utils.get_original_cwd(), cfg.data.root_dir)</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>    <span class="c1"># NOTE: RNADataset might resolve root_dir itself, check its implementation</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded Hydra Config:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>    <span class="k">return</span> <span class="n">cfg</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_dataset_loading</span><span class="p">(</span><span class="n">hydra_config</span><span class="p">):</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests dataset instantiation and single item retrieval.&quot;&quot;&quot;</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing RNADataset ---&quot;</span><span class="p">)</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>    <span class="c1"># Pass cfg directly to RNADataset</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">RNADataset</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="n">hydra_config</span><span class="p">,</span> <span class="n">load_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">load_ang</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Dataset is empty!&quot;</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fetching first sample (sample1)...&quot;</span><span class="p">)</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>    <span class="n">sample1</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Corresponds to sample1.pdb</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sample 1 keys:&quot;</span><span class="p">,</span> <span class="n">sample1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>    <span class="k">assert</span> <span class="s1">&#39;angles_true&#39;</span> <span class="ow">in</span> <span class="n">sample1</span><span class="p">,</span> <span class="s2">&quot;&#39;angles_true&#39; key missing from sample1&quot;</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample1</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">),</span> <span class="s2">&quot;&#39;angles_true&#39; is not a Tensor&quot;</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>    <span class="k">assert</span> <span class="n">sample1</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">hydra_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max_res</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Sample 1 shape mismatch: Expected </span><span class="si">{</span><span class="p">(</span><span class="n">hydra_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max_res</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">sample1</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>    <span class="k">assert</span> <span class="n">sample1</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Sample 1 dtype mismatch: Expected float32, got </span><span class="si">{</span><span class="n">sample1</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>    <span class="c1"># Check that padded values are zero</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sample1</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">][</span><span class="mi">10</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Padding values are not zero for sample1&quot;</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sample 1 verification PASSED.&quot;</span><span class="p">)</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fetching second sample (sample2)...&quot;</span><span class="p">)</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>    <span class="n">sample2</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Corresponds to sample2.cif</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>    <span class="k">assert</span> <span class="s1">&#39;angles_true&#39;</span> <span class="ow">in</span> <span class="n">sample2</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample2</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>    <span class="k">assert</span> <span class="n">sample2</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">hydra_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max_res</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sample2</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">][</span><span class="mi">20</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Padding values are not zero for sample2&quot;</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sample 2 verification PASSED.&quot;</span><span class="p">)</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>    <span class="c1"># Optional: Test missing angle file handling if sample3 was included</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>    <span class="c1"># print(&quot;\nFetching third sample (sample3 - missing angle file)...&quot;)</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>    <span class="c1"># sample3 = dataset[2]</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>    <span class="c1"># assert &#39;angles_true&#39; in sample3</span>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>    <span class="c1"># assert isinstance(sample3[&#39;angles_true&#39;], torch.Tensor)</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>    <span class="c1"># assert sample3[&#39;angles_true&#39;].shape == (hydra_config.data.max_res, 7)</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>    <span class="c1"># assert torch.all(sample3[&#39;angles_true&#39;] == 0), &quot;Placeholder for missing angle file is not zeros&quot;</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>    <span class="c1"># print(&quot;Sample 3 (missing file) verification PASSED.&quot;)</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_dataloader_collation</span><span class="p">(</span><span class="n">hydra_config</span><span class="p">):</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests DataLoader and collation function.&quot;&quot;&quot;</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing DataLoader &amp; Collation ---&quot;</span><span class="p">)</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">RNADataset</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="n">hydra_config</span><span class="p">,</span> <span class="n">load_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">load_ang</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Less verbose here</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>    <span class="c1"># Use debug_logging=True in collate_fn for verbose output</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">hydra_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">rna_collate_fn</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">debug_logging</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fetching first batch...&quot;</span><span class="p">)</span>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>    <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Batch keys:&quot;</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>    <span class="k">assert</span> <span class="s1">&#39;angles_true&#39;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">,</span> <span class="s2">&quot;&#39;angles_true&#39; key missing from batch&quot;</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;&#39;angles_true&#39; is not a Tensor in batch, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>    <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">hydra_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">hydra_config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max_res</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>    <span class="k">assert</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">expected_shape</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Expected batch shape </span><span class="si">{</span><span class="n">expected_shape</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>    <span class="k">assert</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Expected batch dtype torch.float32, got </span><span class="si">{</span><span class="n">batch</span><span class="p">[</span><span class="s1">&#39;angles_true&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Batch collation verification PASSED.&quot;</span><span class="p">)</span>
<a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a>
<a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a><span class="c1"># To run this test: pytest tests/integration/test_angle_loading.py -s</span>
</code></pre></div></p>
</li>
<li><strong>Run:</strong> Execute the test script using <code>pytest -s tests/integration/test_angle_loading.py</code> (the <code>-s</code> shows print statements). Examine the output logs from the dataset and collate function, and check if the assertions pass.</li>
</ul>
<hr />
<h1 id="this-detailed-breakdown-for-phase-1-provides-specific-code-changes-assumptions-critical-considerations-and-a-verification-plan-to-ensure-ground-truth-angles-are-correctly-loaded-and-batched-setting-the-stage-for-implementing-the-direct-angle-loss-in-the-next-phase">This detailed breakdown for Phase 1 provides specific code changes, assumptions, critical considerations, and a verification plan to ensure ground truth angles are correctly loaded and batched, setting the stage for implementing the direct angle loss in the next phase.</h1>
<p>Okay, you are absolutely correct. We cannot just <em>assume</em> the ground truth torsion angle data exists in the required format (<code>.pt</code> files with <code>[L, 7]</code> tensors in radians). That was a placeholder assumption in the previous plan. We need a concrete strategy to <strong>generate</strong> this ground truth data from the existing 3D coordinate files (PDB/CIF).</p>
<p>This requires analyzing the candidate tools (X3DNA-DSSR, MDAnalysis) and selecting the best one for <strong>pre-computing highly accurate torsion angles</strong> for the entire dataset.</p>
<p><strong>Deep Dive: Selecting the Best Tool for Pre-computing Ground Truth Torsion Angles</strong></p>
<p><strong>Goal:</strong> Choose a tool that accurately calculates standard RNA torsion angles (, , , , , , ), handles real-world PDB/CIF complexities (modified residues, missing atoms), is scriptable for batch processing, and provides output in a usable format (e.g., numerical values).</p>
<p><strong>Analysis of Candidate Tools:</strong></p>
<ol>
<li>
<p><strong>X3DNA-DSSR:</strong></p>
<ul>
<li><strong>Pros:</strong><ul>
<li><strong>Specialized for Nucleic Acids:</strong> Designed specifically for RNA/DNA, deeply understands conventions (torsion definitions, base pairing, Leontis-Westhof, Saenger).</li>
<li><strong>High Accuracy:</strong> Widely regarded as a gold standard for RNA structural analysis. The documentation explicitly mentions correcting errors from other tools.</li>
<li><strong>Robust Handling of Modifications:</strong> Automatically maps dozens of common modified residues to standard parents, ensuring calculations don't fail on non-standard bases.</li>
<li><strong>Handles Edge Cases:</strong> Specific flags for NMR ensembles (<code>--nmr</code>) and symmetric assemblies (<code>--symm</code>). Robust to missing atoms (outputs <code>---</code>).</li>
<li><strong>Scriptable:</strong> Excellent command-line interface.</li>
<li><strong>Convenient Output:</strong> <code>--json</code> flag provides structured, machine-readable output containing torsion angles (typically in degrees) which is easy to parse in Python. The <code>--torsion-file</code> provides a dedicated text file.</li>
<li><strong>Fast:</strong> As a compiled binary, it's very efficient for processing individual files.</li>
</ul>
</li>
<li><strong>Cons:</strong><ul>
<li><strong>Licensing:</strong> Requires obtaining a license (free for academics, paid for commercial). This is a one-time setup step.</li>
<li><strong>Installation:</strong> Not a simple <code>pip install</code>. Requires downloading a binary and potentially setting PATH.</li>
<li><strong>Output Units:</strong> Outputs angles in <strong>degrees</strong> by default, requiring conversion to radians for use with PyTorch trigonometric functions (<code>torch.sin</code>, <code>torch.cos</code>).</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>MDAnalysis:</strong></p>
<ul>
<li><strong>Pros:</strong><ul>
<li><strong>Python Native:</strong> Integrates seamlessly into Python data pipelines (<code>pip install mdanalysis</code>).</li>
<li><strong>Flexible:</strong> The general <code>analysis.dihedrals.Dihedral</code> class can calculate <em>any</em> dihedral if the 4 atoms are correctly selected.</li>
<li><strong>Open Source:</strong> LGPL license, easy installation.</li>
<li><strong>Trajectory Handling:</strong> Excellent for analyzing MD simulations (though not our primary need here).</li>
<li><strong>Output Units:</strong> Returns angles in <strong>radians</strong> directly, which is convenient for PyTorch.</li>
</ul>
</li>
<li><strong>Cons:</strong><ul>
<li><strong>Not RNA-Specialized:</strong> Lacks built-in knowledge of RNA-specific conventions (-,  definitions, sugar puckers 0-4, modified base handling). The user must manually define the correct 4-atom selections for <em>every</em> angle type, including tricky inter-residue ones (, , ). This is error-prone.</li>
<li><strong>Robustness Dependent on User Code:</strong> Handling missing atoms, altLocs, or modified residues requires explicit, careful Python logic within the selection process. Less robust out-of-the-box compared to DSSR's built-in handling.</li>
<li><strong>Potential Complexity:</strong> Scripting the selection logic for all 7 standard torsions across all residues, handling termini and chain breaks correctly, is significantly more complex than using DSSR's automated calculation.</li>
<li><strong>Potential BAT Class Issue:</strong> The reported issue with the <code>BAT</code> class modifying coordinates unexpectedly (though potentially fixed or specific) raises a minor flag about tool subtleties.</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>Conclusion: Recommendation</strong></p>
<p>For the specific task of <strong>pre-computing accurate ground truth torsion angles for a dataset of RNA structures</strong>, <strong>X3DNA-DSSR is the strongly recommended tool.</strong></p>
<ul>
<li><strong>Reasoning:</strong> Its specialization in nucleic acids ensures higher accuracy and robustness concerning RNA-specific conventions, modified residues, and common structural artifacts found in PDB/CIF files. While MDAnalysis <em>can</em> calculate these angles, the burden of correctly implementing and validating the selections for all RNA angles (especially inter-residue ones) falls entirely on the user, increasing the risk of errors in the "ground truth" data. DSSR automates this complex process reliably. The convenience of JSON output for parsing outweighs the minor inconvenience of the licensing step and degree-to-radian conversion. Speed is also likely superior for batch processing static files.</li>
</ul>
<p><strong>Revised Plan for Phase 1: Pre-computation using DSSR</strong></p>
<p>This replaces the previous assumption of existing <code>.pt</code> files with a concrete generation step.</p>
<p><strong>Phase 1a: Generate Ground Truth Angle Data (One-Time Pre-computation)</strong></p>
<ol>
<li><strong>Obtain DSSR:</strong> Secure the appropriate DSSR binary and license for your operating system. Install it and ensure it's executable (e.g., in your PATH or provide the full path).</li>
<li><strong>Create a Pre-computation Script:</strong> Write a Python script (<code>scripts/preprocessing/compute_ground_truth_angles.py</code> or similar).<ul>
<li><strong>Input:</strong> Path to the main <code>index_csv</code> used by <code>RNADataset</code>, path to the data <code>root_dir</code>.</li>
<li><strong>Logic:</strong><ul>
<li>Read the <code>index_csv</code> into a pandas DataFrame.</li>
<li>Iterate through each row of the DataFrame.</li>
<li>For each row:<ul>
<li>Determine the full path to the structure file (PDB or CIF) using the same logic as <code>RNADataset._get_structure_filepath</code>.</li>
<li>Define the corresponding output <code>.pt</code> file path (e.g., <code>structure_path.with_suffix(".pt")</code>).</li>
<li><strong>Check if output <code>.pt</code> file already exists. If yes, skip (allows incremental runs).</strong></li>
<li>Construct the DSSR command: <code>dssr_cmd = ["x3dna-dssr", "--json", f"--input={structure_path}"]</code>.</li>
<li>Run DSSR using <code>subprocess.run(dssr_cmd, capture_output=True, text=True, check=True)</code>. Use <code>check=True</code> to raise an error if DSSR fails.</li>
<li>Use a <code>try...except subprocess.CalledProcessError</code> block to catch DSSR failures and log them (e.g., file parsing errors, DSSR internal errors).</li>
<li>Inside the <code>try</code> block (after successful DSSR run):<ul>
<li>Parse the JSON output: <code>dssr_data = json.loads(result.stdout)</code>.</li>
<li>Check if <code>"nts"</code> (nucleotides) key exists and is not empty. If empty, log a warning (e.g., protein-only file) and continue to the next structure.</li>
<li>Initialize an empty list <code>all_angles = []</code>.</li>
<li>Iterate through the nucleotides in <code>dssr_data["nts"]</code>:<ul>
<li>Extract the 7 standard torsion angles: <code>alpha</code>, <code>beta</code>, <code>gamma</code>, <code>delta</code>, <code>epsilon</code>, <code>zeta</code>, <code>chi</code>.</li>
<li><strong>Handle Missing Values:</strong> DSSR JSON might use <code>null</code> for undefined angles (e.g., alpha/zeta at termini). Replace <code>null</code> with a chosen placeholder, typically <code>0.0</code> or <code>np.nan</code>. Using <code>0.0</code> is often simpler if subsequent masking in the loss function is handled correctly. Using <code>np.nan</code> requires handling NaNs during loss calculation. <strong>Let's choose <code>0.0</code> for simplicity initially.</strong></li>
<li><strong>Convert Degrees to Radians:</strong> <code>angle_rad = angle_deg * np.pi / 180.0</code> for each extracted angle.</li>
<li>Append the list/tuple of 7 radian values for this nucleotide to <code>all_angles</code>.</li>
</ul>
</li>
<li>Convert the list of lists to a NumPy array: <code>angle_array_np = np.array(all_angles, dtype=np.float32)</code>. Shape should be <code>[L, 7]</code>.</li>
<li>Convert to a PyTorch tensor: <code>angle_tensor = torch.from_numpy(angle_array_np)</code>.</li>
<li><strong>Save the Tensor:</strong> <code>torch.save(angle_tensor, output_pt_path)</code>.</li>
<li>Log success for this file.</li>
</ul>
</li>
</ul>
</li>
<li>Include overall progress reporting (e.g., using <code>tqdm</code> for the main loop).</li>
</ul>
</li>
</ul>
</li>
<li><strong>Run the Script:</strong> Execute this script once over your entire training/validation dataset. This populates the data directory with the necessary <code>.pt</code> angle files.</li>
</ol>
<p><strong>Phase 1b: Adapt Data Loading (As Before, but Simpler)</strong></p>
<p>Now that the <code>.pt</code> files are guaranteed to exist (or were skipped with logs during pre-computation), the implementation in <code>RNADataset</code> becomes simpler.</p>
<ol>
<li>
<p><strong>File: <code>rna_predict/conf/data/default.yaml</code></strong></p>
<ul>
<li><strong>Action:</strong> Set <code>load_ang: true</code>. (No change from previous plan here).</li>
</ul>
</li>
<li>
<p><strong>File: <code>rna_predict/dataset/loader.py</code> (<code>RNADataset</code>)</strong></p>
<ul>
<li><strong>Action:</strong> Implement <code>_load_angles</code> to <em>only load</em> the pre-computed <code>.pt</code> file. The complex DSSR call is removed.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Inside RNADataset class</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">_load_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads pre-computed ground truth torsion angles from a .pt file.&quot;&quot;&quot;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">angle_path</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>        <span class="n">structure_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_structure_filepath</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="c1"># Assumes this helper exists and works</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        <span class="n">angle_path</span> <span class="o">=</span> <span class="n">structure_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pt&quot;</span><span class="p">)</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">angle_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>            <span class="c1"># This case should be less frequent now if pre-computation was run</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-computed angle file not found: </span><span class="si">{</span><span class="n">angle_path</span><span class="si">}</span><span class="s2">. Returning None.&quot;</span><span class="p">)</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>        <span class="c1"># Load the tensor data</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>        <span class="n">angles_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">angle_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>        <span class="c1"># Basic validation (optional, as pre-computation should ensure this)</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angles_tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">or</span> <span class="n">angles_tensor</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">angles_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid data in pre-computed angle file </span><span class="si">{</span><span class="n">angle_path</span><span class="si">}</span><span class="s2">. Shape: </span><span class="si">{</span><span class="n">angles_tensor</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">angles_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>             <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>        <span class="k">return</span> <span class="n">angles_tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># Ensure correct dtype</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading pre-computed angles for </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">angle_path</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">angle_path</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;unknown path&#39;</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></li>
<li><strong>Action:</strong> Modify <code>__getitem__</code> to call the <em>simplified</em> <code>_load_angles</code> and handle padding/placeholder creation as outlined in the previous plan's step 2.3. The logic remains the same, but it now relies on the pre-computed files.</li>
</ul>
</li>
<li>
<p><strong>File: <code>rna_predict/dataset/collate.py</code> (<code>rna_collate_fn</code>)</strong></p>
<ul>
<li><strong>Action:</strong> Ensure collation handles <code>angles_true</code> correctly (no change from previous plan's step 3.1).</li>
</ul>
</li>
<li>
<p><strong>Verification Plan:</strong></p>
<ul>
<li>Run the DSSR pre-computation script on your test data subset. Verify <code>.pt</code> files are created.</li>
<li>Run the <code>tests/integration/test_angle_loading.py</code> script (from the previous plan). It should now pass by loading the pre-computed <code>.pt</code> files.</li>
</ul>
</li>
</ol>
<hr />
<p><strong>Summary of Refined Phase 1:</strong></p>
<ol>
<li><strong>Pre-computation:</strong> Use a dedicated script leveraging X3DNA-DSSR (<code>--json</code> output) to iterate through all structure files, calculate standard torsion angles (-, ), convert them to <strong>radians</strong>, and save them as <code>[L, 7]</code> <code>torch.float32</code> tensors in <code>.pt</code> files (e.g., <code>structure.pt</code>) alongside the original structure files. Handle errors and missing atoms gracefully during this step.</li>
<li><strong>Data Loading:</strong> Modify <code>RNADataset</code> to simply load these pre-computed <code>.pt</code> files when <code>cfg.data.load_ang</code> is true. Implement padding/truncation and placeholder logic for missing files within <code>__getitem__</code>.</li>
<li><strong>Collation:</strong> Ensure <code>rna_collate_fn</code> stacks the loaded <code>angles_true</code> tensors correctly into batches.</li>
</ol>
<h1 id="this-approach-ensures-accuracy-by-using-a-specialized-tool-dssr-improves-efficiency-by-pre-computing-angles-once-and-simplifies-the-data-loading-logic-within-rnadataset">This approach ensures accuracy by using a specialized tool (DSSR), improves efficiency by pre-computing angles once, and simplifies the data loading logic within <code>RNADataset</code>.</h1>
<p>Okay, let's perform a meticulous deep dive into <strong>Phase 2: Integrating Stage D into Training</strong> within the <code>RNALightningModule</code>. This phase is the most complex part of the refactoring, as it connects multiple stages and introduces the core diffusion training logic.</p>
<p><strong>Goal:</strong> Modify <code>RNALightningModule.training_step</code> to correctly prepare inputs for Stage D, execute its training step, compute the appropriate diffusion loss (<code>L_diffusion</code>), and ensure gradients propagate back to Stage D and the upstream conditioning modules (TorsionBERT, Pairformer, LatentMerger).</p>
<hr />
<p><strong>Detailed Implementation Steps &amp; Considerations:</strong></p>
<p><strong>3. File: <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule</code>) - Prepare Inputs for Stage D</strong></p>
<ul>
<li>
<p><strong>Action 3.1: Define Helpers for Noise Sampling and Application.</strong></p>
<ul>
<li><strong>Rationale:</strong> Encapsulate the logic for noise schedule sampling and adding noise to coordinates for better readability and potential reuse.</li>
<li><strong>Implementation:</strong> Add <code>_sample_noise_level</code> and <code>_add_noise</code> methods to <code>RNALightningModule</code>.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Inside RNALightningModule class</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">_sample_noise_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Samples noise level sigma_t for each item in the batch based on config.&quot;&quot;&quot;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="c1"># Access noise schedule config safely</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="n">noise_schedule_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="s1">&#39;stageD&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="s1">&#39;diffusion&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noise_schedule&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">p_mean</span> <span class="o">=</span> <span class="n">noise_schedule_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_mean&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">p_std</span> <span class="o">=</span> <span class="n">noise_schedule_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_std&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="c1"># Access sigma_data safely from model_architecture</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="n">model_arch_cfg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="s1">&#39;stageD&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="s1">&#39;diffusion&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_architecture&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="n">sigma_data</span> <span class="o">=</span> <span class="n">model_arch_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sigma_data&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Default to 1.0 for EDM-like schedule</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="c1"># Log the parameters being used</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Noise sampling params: p_mean=</span><span class="si">{</span><span class="n">p_mean</span><span class="si">}</span><span class="s2">, p_std=</span><span class="si">{</span><span class="n">p_std</span><span class="si">}</span><span class="s2">, sigma_data=</span><span class="si">{</span><span class="n">sigma_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    <span class="c1"># AF3-like exponential schedule (log-normal distribution for sigma)</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="c1"># log_snr = torch.randn(batch_size, device=self.device_) * p_std + p_mean # SNR = 1/sigma^2 -&gt; log(SNR) = -2*log(sigma)</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>    <span class="c1"># log_sigma = -0.5 * log_snr</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>    <span class="c1"># sigma_t = sigma_data * torch.exp(log_sigma)</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>    <span class="c1"># Simpler Placeholder: Uniform sampling in log space</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>    <span class="n">min_log_sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">noise_schedule_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;s_min&#39;</span><span class="p">,</span> <span class="mf">0.002</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">))</span> <span class="c1"># Use s_min from config</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>    <span class="n">max_log_sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">noise_schedule_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;s_max&#39;</span><span class="p">,</span> <span class="mf">80.0</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">))</span> <span class="c1"># Use s_max from config</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="n">log_sigma_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_log_sigma</span> <span class="o">-</span> <span class="n">min_log_sigma</span><span class="p">)</span> <span class="o">+</span> <span class="n">min_log_sigma</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="n">sigma_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_sigma_t</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sampled sigma_t (noise levels, shape </span><span class="si">{</span><span class="n">sigma_t</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">sigma_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>    <span class="k">return</span> <span class="n">sigma_t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">)</span> <span class="c1"># Ensure device</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">_add_noise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords_true</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">sigma_t</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds Gaussian noise based on sampled noise levels sigma_t.&quot;&quot;&quot;</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>    <span class="k">if</span> <span class="n">coords_true</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Handle empty coordinates</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>         <span class="k">return</span> <span class="n">coords_true</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">coords_true</span><span class="p">)</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">coords_true</span><span class="p">)</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>    <span class="c1"># Ensure sigma_t can broadcast to coords_true shape [B, N_atom, 3]</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>    <span class="c1"># sigma_t is [B], need [B, 1, 1]</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>    <span class="n">sigma_t_reshaped</span> <span class="o">=</span> <span class="n">sigma_t</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">coords_true</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>    <span class="n">coords_noisy</span> <span class="o">=</span> <span class="n">coords_true</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">sigma_t_reshaped</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added noise: coords_true.shape=</span><span class="si">{</span><span class="n">coords_true</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, sigma_t.shape=</span><span class="si">{</span><span class="n">sigma_t</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, epsilon.shape=</span><span class="si">{</span><span class="n">epsilon</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, coords_noisy.shape=</span><span class="si">{</span><span class="n">coords_noisy</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>    <span class="k">return</span> <span class="n">coords_noisy</span><span class="p">,</span> <span class="n">epsilon</span>
</code></pre></div></li>
<li><strong>Critical Check:</strong> The specific noise sampling strategy (<code>_sample_noise_level</code>) directly impacts training stability and performance. The AF3 schedule is complex; starting with a simpler schedule (like linear or uniform log-space) might be easier initially. <strong>Verify <code>sigma_data</code>, <code>s_min</code>, <code>s_max</code> are correctly read from the config.</strong></li>
</ul>
</li>
<li>
<p><strong>Action 3.2: Gather and Prepare Inputs within <code>training_step</code>.</strong></p>
<ul>
<li><strong>Code Snippet (Inside <code>training_step</code>):</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># (Ensure self.forward(batch) has been called to get &#39;output&#39; dict)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="c1"># ... (L_angle calculation from Phase 1) ...</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Preparing Stage D Inputs ---&quot;</span><span class="p">)</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="c1"># 1. Ground Truth Coords &amp; Mask</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="c1"># Ensure keys exist in the batch, handle potential errors</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="k">if</span> <span class="s2">&quot;coords_true&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch</span> <span class="ow">or</span> <span class="s2">&quot;atom_mask&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Batch missing &#39;coords_true&#39; or &#39;atom_mask&#39;. Cannot proceed with Stage D training.&quot;</span><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="c1"># Return a minimal loss or raise error</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss_angle</span> <span class="k">if</span> <span class="s1">&#39;loss_angle&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="n">coords_true</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;coords_true&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">)</span> <span class="c1"># Shape [B, N_atom_padded, 3]</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="n">atom_mask</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;atom_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">)</span>     <span class="c1"># Shape [B, N_atom_padded] bool</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="c1"># 2. Sample Noise Level &amp; Add Noise</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="n">batch_size</span> <span class="o">=</span> <span class="n">coords_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="n">sigma_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_noise_level</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="c1"># Shape [B]</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="n">coords_noisy</span><span class="p">,</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_noise</span><span class="p">(</span><span class="n">coords_true</span><span class="p">,</span> <span class="n">sigma_t</span><span class="p">)</span> <span class="c1"># Shapes [B, N_atom_padded, 3]</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="c1"># 3. Retrieve Stage B Outputs (Residue Level) from `output` dict</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="k">if</span> <span class="s2">&quot;s_embeddings&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">or</span> <span class="s2">&quot;z_embeddings&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>     <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Missing &#39;s_embeddings&#39; or &#39;z_embeddings&#39; from self.forward output dict.&quot;</span><span class="p">)</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>     <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss_angle</span><span class="p">}</span> <span class="c1"># Fallback</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="n">s_embeddings_res</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;s_embeddings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">)</span> <span class="c1"># Shape [B, N_res_padded, C_s]</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="n">z_embeddings_res</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;z_embeddings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">)</span> <span class="c1"># Shape [B, N_res_padded, N_res_padded, C_z]</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="c1"># 4. Bridging from Residue to Atom Level (CRITICAL)</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="k">if</span> <span class="s1">&#39;atom_to_token_idx&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Batch missing &#39;atom_to_token_idx&#39; needed for residue-to-atom bridging.&quot;</span><span class="p">)</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="n">atom_to_token_idx</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;atom_to_token_idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">)</span> <span class="c1"># Shape [B, N_atom_padded]</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a><span class="c1"># --- Bridging s_embeddings ---</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rna_predict.utils.tensor_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">residue_to_atoms</span><span class="p">,</span> <span class="n">derive_residue_atom_map</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a><span class="n">s_embeddings_atom_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a><span class="n">n_atoms_padded</span> <span class="o">=</span> <span class="n">coords_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a><span class="k">for</span> <span class="n">b_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>    <span class="c1"># Derive map for this specific item (using its actual atom mask)</span>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>    <span class="n">current_atom_mask</span> <span class="o">=</span> <span class="n">atom_mask</span><span class="p">[</span><span class="n">b_idx</span><span class="p">]</span>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>    <span class="c1"># Provide sequence if available for better mapping</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>    <span class="n">sequence_item</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">][</span><span class="n">b_idx</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;sequence&quot;</span> <span class="ow">in</span> <span class="n">batch</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>    <span class="n">residue_atom_map_item</span> <span class="o">=</span> <span class="n">derive_residue_atom_map</span><span class="p">(</span><span class="n">sequence</span><span class="o">=</span><span class="n">sequence_item</span><span class="p">,</span> <span class="n">atom_mask</span><span class="o">=</span><span class="n">current_atom_mask</span><span class="p">)</span>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">residue_atom_map_item</span><span class="p">:</span>
<a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Empty residue_atom_map derived for batch item </span><span class="si">{</span><span class="n">b_idx</span><span class="si">}</span><span class="s2">. Using zeros.&quot;</span><span class="p">)</span>
<a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>         <span class="n">s_embeddings_atom_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_atoms_padded</span><span class="p">,</span> <span class="n">s_embeddings_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">s_embeddings_res</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
<a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>         <span class="k">continue</span>
<a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>
<a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>    <span class="c1"># Bridge using the derived map</span>
<a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a>        <span class="c1"># residue_to_atoms expects [N_res, C] and returns [N_atom_actual, C]</span>
<a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a>        <span class="n">s_atom_actual</span> <span class="o">=</span> <span class="n">residue_to_atoms</span><span class="p">(</span><span class="n">s_embeddings_res</span><span class="p">[</span><span class="n">b_idx</span><span class="p">],</span> <span class="n">residue_atom_map_item</span><span class="p">)</span>
<a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a>        <span class="c1"># Pad back to N_atom_padded</span>
<a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>        <span class="n">padded_s_atom</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_atoms_padded</span><span class="p">,</span> <span class="n">s_atom_actual</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">s_atom_actual</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a>        <span class="n">real_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">current_atom_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Indices of real atoms</span>
<a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a>        <span class="n">num_real_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">real_indices</span><span class="p">)</span>
<a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a>        <span class="c1"># Ensure slicing matches actual number of atoms returned by bridging</span>
<a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a>        <span class="n">padded_s_atom</span><span class="p">[</span><span class="n">real_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_atom_actual</span><span class="p">[:</span><span class="n">num_real_atoms</span><span class="p">]</span>
<a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a>        <span class="n">s_embeddings_atom_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_s_atom</span><span class="p">)</span>
<a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error bridging s_embeddings for batch item </span><span class="si">{</span><span class="n">b_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>        <span class="n">s_embeddings_atom_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_atoms_padded</span><span class="p">,</span> <span class="n">s_embeddings_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">s_embeddings_res</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
<a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a>
<a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a><span class="n">s_embeddings_atom</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">s_embeddings_atom_list</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Shape [B, N_atom_padded, C_s]</span>
<a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bridged s_embeddings_atom shape: </span><span class="si">{</span><span class="n">s_embeddings_atom</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a>
<a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a><span class="c1"># --- Bridging z_embeddings (Optional but potentially needed by Stage D) ---</span>
<a id="__codelineno-10-69" name="__codelineno-10-69" href="#__codelineno-10-69"></a><span class="c1"># If Stage D needs atom-level pair features, implement bridging here.</span>
<a id="__codelineno-10-70" name="__codelineno-10-70" href="#__codelineno-10-70"></a><span class="c1"># This typically involves replicating residue-pair features to corresponding atom-pairs.</span>
<a id="__codelineno-10-71" name="__codelineno-10-71" href="#__codelineno-10-71"></a><span class="c1"># Example (Simple Replication - adapt if Stage D uses a more complex scheme):</span>
<a id="__codelineno-10-72" name="__codelineno-10-72" href="#__codelineno-10-72"></a><span class="c1"># z_embeddings_atom = torch.zeros(batch_size, n_atoms_padded, n_atoms_padded, z_embeddings_res.shape[-1], device=self.device_, dtype=z_embeddings_res.dtype)</span>
<a id="__codelineno-10-73" name="__codelineno-10-73" href="#__codelineno-10-73"></a><span class="c1"># for b_idx in range(batch_size):</span>
<a id="__codelineno-10-74" name="__codelineno-10-74" href="#__codelineno-10-74"></a><span class="c1">#    residue_map_item = derive_residue_atom_map(...) # Derive map again or reuse</span>
<a id="__codelineno-10-75" name="__codelineno-10-75" href="#__codelineno-10-75"></a><span class="c1">#    for res_i, atoms_i in enumerate(residue_map_item):</span>
<a id="__codelineno-10-76" name="__codelineno-10-76" href="#__codelineno-10-76"></a><span class="c1">#        for res_j, atoms_j in enumerate(residue_map_item):</span>
<a id="__codelineno-10-77" name="__codelineno-10-77" href="#__codelineno-10-77"></a><span class="c1">#            if atoms_i and atoms_j: # Only if both residues have atoms</span>
<a id="__codelineno-10-78" name="__codelineno-10-78" href="#__codelineno-10-78"></a><span class="c1">#                 # Get indices for atoms in res_i and res_j</span>
<a id="__codelineno-10-79" name="__codelineno-10-79" href="#__codelineno-10-79"></a><span class="c1">#                 idx_i = torch.tensor(atoms_i, device=self.device_)</span>
<a id="__codelineno-10-80" name="__codelineno-10-80" href="#__codelineno-10-80"></a><span class="c1">#                 idx_j = torch.tensor(atoms_j, device=self.device_)</span>
<a id="__codelineno-10-81" name="__codelineno-10-81" href="#__codelineno-10-81"></a><span class="c1">#                 # Assign residue-pair value to all atom-pairs</span>
<a id="__codelineno-10-82" name="__codelineno-10-82" href="#__codelineno-10-82"></a><span class="c1">#                 # Need meshgrid for multi-dim assignment</span>
<a id="__codelineno-10-83" name="__codelineno-10-83" href="#__codelineno-10-83"></a><span class="c1">#                 mesh_i, mesh_j = torch.meshgrid(idx_i, idx_j, indexing=&#39;ij&#39;)</span>
<a id="__codelineno-10-84" name="__codelineno-10-84" href="#__codelineno-10-84"></a><span class="c1">#                 z_embeddings_atom[b_idx, mesh_i, mesh_j, :] = z_embeddings_res[b_idx, res_i, res_j, :]</span>
<a id="__codelineno-10-85" name="__codelineno-10-85" href="#__codelineno-10-85"></a><span class="c1"># Placeholder: Keep z as residue-level for now, assume Stage D handles it</span>
<a id="__codelineno-10-86" name="__codelineno-10-86" href="#__codelineno-10-86"></a><span class="n">z_embeddings_atom</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Set to None if not bridged</span>
<a id="__codelineno-10-87" name="__codelineno-10-87" href="#__codelineno-10-87"></a><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;z_embeddings (residue level) shape: </span><span class="si">{</span><span class="n">z_embeddings_res</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-88" name="__codelineno-10-88" href="#__codelineno-10-88"></a>
<a id="__codelineno-10-89" name="__codelineno-10-89" href="#__codelineno-10-89"></a><span class="c1"># 5. Prepare Conditioning Signal Dictionary for StageDContext</span>
<a id="__codelineno-10-90" name="__codelineno-10-90" href="#__codelineno-10-90"></a><span class="c1"># Adapt keys based on what StageDContext / run_stageD expects</span>
<a id="__codelineno-10-91" name="__codelineno-10-91" href="#__codelineno-10-91"></a><span class="c1"># Typically: s_trunk (residue), s_inputs (atom), pair/z_trunk (residue or atom)</span>
<a id="__codelineno-10-92" name="__codelineno-10-92" href="#__codelineno-10-92"></a><span class="n">conditioning_signal</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-10-93" name="__codelineno-10-93" href="#__codelineno-10-93"></a>    <span class="s2">&quot;s_trunk&quot;</span><span class="p">:</span> <span class="n">s_embeddings_res</span><span class="p">,</span> <span class="c1"># Keep residue level for potential use</span>
<a id="__codelineno-10-94" name="__codelineno-10-94" href="#__codelineno-10-94"></a>    <span class="s2">&quot;pair&quot;</span><span class="p">:</span> <span class="n">z_embeddings_res</span><span class="p">,</span>    <span class="c1"># Keep residue level for potential use</span>
<a id="__codelineno-10-95" name="__codelineno-10-95" href="#__codelineno-10-95"></a>    <span class="s2">&quot;s_inputs&quot;</span><span class="p">:</span> <span class="n">s_embeddings_atom</span><span class="p">,</span><span class="c1"># Pass atom level</span>
<a id="__codelineno-10-96" name="__codelineno-10-96" href="#__codelineno-10-96"></a>    <span class="s2">&quot;z_atom&quot;</span><span class="p">:</span> <span class="n">z_embeddings_atom</span><span class="p">,</span> <span class="c1"># Pass atom level if bridged, else None</span>
<a id="__codelineno-10-97" name="__codelineno-10-97" href="#__codelineno-10-97"></a>    <span class="c1"># Pass other batch features needed by Stage D / Context</span>
<a id="__codelineno-10-98" name="__codelineno-10-98" href="#__codelineno-10-98"></a>    <span class="s2">&quot;atom_mask&quot;</span><span class="p">:</span> <span class="n">atom_mask</span><span class="p">,</span>
<a id="__codelineno-10-99" name="__codelineno-10-99" href="#__codelineno-10-99"></a>    <span class="s2">&quot;atom_to_token_idx&quot;</span><span class="p">:</span> <span class="n">atom_to_token_idx</span><span class="p">,</span>
<a id="__codelineno-10-100" name="__codelineno-10-100" href="#__codelineno-10-100"></a>    <span class="c1"># Add input_feature_dict content needed by ProtenixDiffusionManager</span>
<a id="__codelineno-10-101" name="__codelineno-10-101" href="#__codelineno-10-101"></a>    <span class="c1"># e.g., ref_element, ref_charge if used by conditioning</span>
<a id="__codelineno-10-102" name="__codelineno-10-102" href="#__codelineno-10-102"></a>    <span class="s2">&quot;ref_element&quot;</span><span class="p">:</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ref_element&quot;</span><span class="p">),</span>
<a id="__codelineno-10-103" name="__codelineno-10-103" href="#__codelineno-10-103"></a>    <span class="s2">&quot;ref_atom_name_chars&quot;</span><span class="p">:</span> <span class="n">batch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ref_atom_name_chars&quot;</span><span class="p">),</span>
<a id="__codelineno-10-104" name="__codelineno-10-104" href="#__codelineno-10-104"></a>    <span class="c1"># etc.</span>
<a id="__codelineno-10-105" name="__codelineno-10-105" href="#__codelineno-10-105"></a><span class="p">}</span>
<a id="__codelineno-10-106" name="__codelineno-10-106" href="#__codelineno-10-106"></a>
<a id="__codelineno-10-107" name="__codelineno-10-107" href="#__codelineno-10-107"></a><span class="c1"># Optional: Unified Latent Merger</span>
<a id="__codelineno-10-108" name="__codelineno-10-108" href="#__codelineno-10-108"></a><span class="n">unified_latent</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-10-109" name="__codelineno-10-109" href="#__codelineno-10-109"></a><span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;merge_latent&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="c1"># Default to True based on design docs</span>
<a id="__codelineno-10-110" name="__codelineno-10-110" href="#__codelineno-10-110"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Running Latent Merger ---&quot;</span><span class="p">)</span>
<a id="__codelineno-10-111" name="__codelineno-10-111" href="#__codelineno-10-111"></a>    <span class="c1"># Prepare inputs for the merger (ensure correct device)</span>
<a id="__codelineno-10-112" name="__codelineno-10-112" href="#__codelineno-10-112"></a>    <span class="c1"># Note: SimpleLatentMerger expects residue-level inputs based on its forward sig</span>
<a id="__codelineno-10-113" name="__codelineno-10-113" href="#__codelineno-10-113"></a>    <span class="n">merge_inputs</span> <span class="o">=</span> <span class="n">LatentInputs</span><span class="p">(</span>
<a id="__codelineno-10-114" name="__codelineno-10-114" href="#__codelineno-10-114"></a>        <span class="n">adjacency</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;adjacency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">),</span>
<a id="__codelineno-10-115" name="__codelineno-10-115" href="#__codelineno-10-115"></a>        <span class="n">angles</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="s2">&quot;torsion_angles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">),</span> <span class="c1"># Shape [B, N_res, C_angle]</span>
<a id="__codelineno-10-116" name="__codelineno-10-116" href="#__codelineno-10-116"></a>        <span class="n">s_emb</span><span class="o">=</span><span class="n">s_embeddings_res</span><span class="p">,</span>                           <span class="c1"># Shape [B, N_res, C_s]</span>
<a id="__codelineno-10-117" name="__codelineno-10-117" href="#__codelineno-10-117"></a>        <span class="n">z_emb</span><span class="o">=</span><span class="n">z_embeddings_res</span><span class="p">,</span>                           <span class="c1"># Shape [B, N_res, N_res, C_z]</span>
<a id="__codelineno-10-118" name="__codelineno-10-118" href="#__codelineno-10-118"></a>        <span class="c1"># partial_coords is optional, needs careful handling if atom-level</span>
<a id="__codelineno-10-119" name="__codelineno-10-119" href="#__codelineno-10-119"></a>        <span class="n">partial_coords</span><span class="o">=</span><span class="kc">None</span> <span class="c1"># Or pass output[&quot;coords&quot;] if merger handles atom-level coords</span>
<a id="__codelineno-10-120" name="__codelineno-10-120" href="#__codelineno-10-120"></a>    <span class="p">)</span>
<a id="__codelineno-10-121" name="__codelineno-10-121" href="#__codelineno-10-121"></a>    <span class="n">unified_latent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_merger</span><span class="p">(</span><span class="n">merge_inputs</span><span class="p">)</span> <span class="c1"># Expected output [B, N_res, C_latent]</span>
<a id="__codelineno-10-122" name="__codelineno-10-122" href="#__codelineno-10-122"></a>    <span class="n">conditioning_signal</span><span class="p">[</span><span class="s2">&quot;unified_latent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unified_latent</span> <span class="c1"># Add to conditioning dict</span>
<a id="__codelineno-10-123" name="__codelineno-10-123" href="#__codelineno-10-123"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unified Latent shape: </span><span class="si">{</span><span class="n">unified_latent</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unified_latent</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-10-124" name="__codelineno-10-124" href="#__codelineno-10-124"></a>    <span class="c1"># CRITICAL: If Stage D needs atom-level unified_latent, bridge it here.</span>
<a id="__codelineno-10-125" name="__codelineno-10-125" href="#__codelineno-10-125"></a>    <span class="c1"># Example: unified_latent_atom = residue_to_atoms(unified_latent, residue_map_list_of_lists_batched)</span>
<a id="__codelineno-10-126" name="__codelineno-10-126" href="#__codelineno-10-126"></a>    <span class="c1"># conditioning_signal[&quot;unified_latent_atom&quot;] = unified_latent_atom</span>
<a id="__codelineno-10-127" name="__codelineno-10-127" href="#__codelineno-10-127"></a>
<a id="__codelineno-10-128" name="__codelineno-10-128" href="#__codelineno-10-128"></a><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Stage D Input Preparation Complete ---&quot;</span><span class="p">)</span>
</code></pre></div></li>
<li><strong>Critical Considerations:</strong><ul>
<li><strong>Bridging Accuracy:</strong> The correctness of <code>derive_residue_atom_map</code> and <code>residue_to_atoms</code> is paramount. Errors here will propagate incorrect conditioning signals. Test this bridging extensively.</li>
<li><strong><code>z_embeddings</code> Bridging:</strong> Determine if Stage D requires atom-level pair embeddings (<code>z_atom</code>). If so, implement the bridging (e.g., the replication logic sketched above). If not, pass <code>z_embeddings_res</code>.</li>
<li><strong>Conditioning Dictionary Keys:</strong> Ensure the keys in <code>conditioning_signal</code> match precisely what <code>StageDContext</code> and <code>run_stageD</code> expect. Rename keys if necessary (e.g., maybe Stage D expects <code>"pair"</code> instead of <code>"z_trunk"</code>).</li>
<li><strong>Unified Latent Level:</strong> Decide if the <code>unified_latent</code> should be residue-level (as produced by <code>SimpleLatentMerger</code>) or atom-level. Bridge if needed. Ensure Stage D's conditioning logic handles whichever level is provided.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr />
<p><strong>4. File: <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule</code>) - Execute Stage D</strong></p>
<ul>
<li><strong>Action 4.1:</strong> Call <code>run_stageD</code> using <code>StageDContext</code>.<ul>
<li><strong>Code Snippet (Inside <code>training_step</code>, after input prep):</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Executing Stage D ---&quot;</span><span class="p">)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rna_predict.pipeline.stageD.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">StageDContext</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rna_predict.pipeline.stageD.run_stageD</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_stageD</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="c1"># Create the context object, mapping prepared signals to context fields</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1"># Ensure atom_metadata contains at least residue_indices for bridging inside run_stageD</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">atom_metadata_for_stageD</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>     <span class="s2">&quot;residue_indices&quot;</span><span class="p">:</span> <span class="n">atom_to_token_idx</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Assuming batch size 1 for now, needs adjustment if B &gt; 1</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>     <span class="c1"># Add other metadata like atom_names if available and needed</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="p">}</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="k">if</span> <span class="s1">&#39;atom_names&#39;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span> <span class="n">atom_metadata_for_stageD</span><span class="p">[</span><span class="s1">&#39;atom_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;atom_names&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Assuming B=1</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="n">stage_d_context</span> <span class="o">=</span> <span class="n">StageDContext</span><span class="p">(</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="n">cfg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span>                      <span class="c1"># Pass the main Hydra config</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>    <span class="n">coords</span><span class="o">=</span><span class="n">coords_noisy</span><span class="p">,</span>               <span class="c1"># Noisy coordinates are the primary input</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="n">s_trunk</span><span class="o">=</span><span class="n">conditioning_signal</span><span class="p">[</span><span class="s2">&quot;s_trunk&quot;</span><span class="p">],</span> <span class="c1"># Residue-level trunk</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>    <span class="n">z_trunk</span><span class="o">=</span><span class="n">conditioning_signal</span><span class="p">[</span><span class="s2">&quot;pair&quot;</span><span class="p">],</span>    <span class="c1"># Residue-level pair</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>    <span class="n">s_inputs</span><span class="o">=</span><span class="n">conditioning_signal</span><span class="p">[</span><span class="s2">&quot;s_inputs&quot;</span><span class="p">],</span><span class="c1"># ATOM-level inputs</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>    <span class="n">input_feature_dict</span><span class="o">=</span><span class="n">conditioning_signal</span><span class="p">,</span> <span class="c1"># Pass the whole dict for flexibility</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>    <span class="n">atom_metadata</span><span class="o">=</span><span class="n">atom_metadata_for_stageD</span><span class="p">,</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>    <span class="n">unified_latent</span><span class="o">=</span><span class="n">unified_latent</span><span class="p">,</span>     <span class="c1"># Pass if merger is used</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span>                      <span class="c1"># Explicitly set train mode</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>    <span class="n">noise_level</span><span class="o">=</span><span class="n">sigma_t</span><span class="p">,</span>               <span class="c1"># Pass noise level for potential use in loss weighting</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    <span class="n">device</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">),</span>          <span class="c1"># Pass device string</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>    <span class="n">debug_logging</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">stageD</span><span class="p">,</span> <span class="s1">&#39;debug_logging&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="p">)</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>    <span class="c1"># Call run_stageD, which should handle training mode internally</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>    <span class="n">stage_d_pred_output</span> <span class="o">=</span> <span class="n">run_stageD</span><span class="p">(</span><span class="n">stage_d_context</span><span class="p">)</span> <span class="c1"># Assuming run_stageD is adapted</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    <span class="c1"># --- Determine what Stage D returned ---</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>    <span class="c1"># Check the type and content of stage_d_pred_output</span>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>    <span class="c1"># Ideally, it returns predicted noise epsilon_hat or denoised coords x_hat_0</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage_d_pred_output</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">stage_d_pred_output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>         <span class="c1"># Example: Assume returns (x_denoised, sigma, x_gt_augment) like ProtenixDiffusionManager.train_diffusion_step</span>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>         <span class="c1"># We need either noise or denoised coords for loss calculation</span>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>         <span class="c1"># If it returns denoised coords:</span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>         <span class="n">stage_d_pred</span> <span class="o">=</span> <span class="n">stage_d_pred_output</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Assuming x_denoised is the second element</span>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>         <span class="n">prediction_type</span> <span class="o">=</span> <span class="s1">&#39;coords&#39;</span> <span class="c1"># Flag for loss calculation</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage_d_pred_output</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>         <span class="c1"># Assume it returned the direct prediction (e.g., noise)</span>
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>         <span class="n">stage_d_pred</span> <span class="o">=</span> <span class="n">stage_d_pred_output</span>
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>         <span class="c1"># ****** ASSUMPTION: Need to know if this tensor is noise or coords ******</span>
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>         <span class="c1"># For now, assume noise prediction based on simpler loss path</span>
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>         <span class="n">prediction_type</span> <span class="o">=</span> <span class="s1">&#39;noise&#39;</span>
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected output type from run_stageD in train mode: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">stage_d_pred_output</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>         <span class="n">stage_d_pred</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>         <span class="n">prediction_type</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>
<a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>    <span class="k">if</span> <span class="n">stage_d_pred</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Stage D training step did not return a usable prediction.&quot;</span><span class="p">)</span>
<a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>
<a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stage D prediction type: </span><span class="si">{</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">, shape: </span><span class="si">{</span><span class="n">stage_d_pred</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">stage_d_pred</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>
<a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during Stage D execution (run_stageD call) in training_step: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a>    <span class="n">stage_d_pred</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>    <span class="n">prediction_type</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>    <span class="c1"># Assign a dummy loss that requires grad to avoid Lightning errors</span>
<a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>    <span class="n">loss_diffusion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a>
<a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Stage D Execution Complete ---&quot;</span><span class="p">)</span>
</code></pre></div></li>
<li><strong>Critical Considerations:</strong><ul>
<li><strong>Adapt <code>run_stageD</code> for Training:</strong> The primary dependency is ensuring <code>run_stageD</code> (and <code>_run_stageD_impl</code>) correctly handles <code>mode='train'</code>. It needs to:<ul>
<li>Recognize the training mode.</li>
<li>Pass the <code>noise_level</code> (<code>sigma_t</code>) to the underlying <code>DiffusionModule</code> or loss calculation.</li>
<li>Return the appropriate prediction (noise or denoised coords) needed for the loss. Currently, <code>_run_stageD_impl</code> seems inference-focused and might just return the final coordinates without loss calculation. This <strong>must</strong> be adapted. Consider adding a dedicated <code>train_stageD</code> function or modifying <code>run_stageD</code> with conditional logic based on <code>context.mode</code>.</li>
</ul>
</li>
<li><strong><code>StageDContext</code> Completeness:</strong> Double-check that <code>StageDContext</code> correctly bundles <em>all</em> information needed by the diffusion model's conditioning mechanism and loss function (including potentially required elements from the original <code>input_feature_dict</code> like masks, residue types, etc.).</li>
<li><strong>Batch Size &gt; 1:</strong> The current snippet assumes batch size 1 in places (like squeezing <code>atom_metadata['residue_indices']</code>). This needs generalization if <code>batch_size &gt; 1</code>. <code>StageDContext</code> should likely hold batched tensors.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr />
<p><strong>5. File: <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule</code>) - Implement Diffusion Loss</strong></p>
<ul>
<li>
<p><strong>Action 5.1:</strong> Calculate <code>L_diffusion</code>.</p>
<ul>
<li><strong>Code Snippet (Inside <code>training_step</code>, after Stage D execution):</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span> <span class="c1"># Ensure F is imported</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;--- Calculating Diffusion Loss ---&quot;</span><span class="p">)</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">loss_diffusion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">)</span> <span class="c1"># Default zero loss</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="c1"># Use the prediction_type determined in Step 4</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="k">if</span> <span class="n">stage_d_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prediction_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="k">if</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;noise&#39;</span><span class="p">:</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating noise prediction loss (MSE)&quot;</span><span class="p">)</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        <span class="n">target_noise</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="c1"># The noise added in step 3.2</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>        <span class="c1"># Apply mask to compute loss only on non-padded atoms</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>        <span class="c1"># Ensure masks have compatible shapes (e.g., [B, N_atom_padded])</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>        <span class="k">if</span> <span class="n">atom_mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">target_noise</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>             <span class="c1"># Attempt to fix common case: mask is [B, N], target is [B, N, 3]</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>             <span class="k">if</span> <span class="n">atom_mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">target_noise</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># Should match if padding is correct</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>                  <span class="n">mask_for_loss</span> <span class="o">=</span> <span class="n">atom_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># -&gt; [B, N, 1]</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>             <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atom mask shape </span><span class="si">{</span><span class="n">atom_mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> incompatible with target noise shape </span><span class="si">{</span><span class="n">target_noise</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Using unmasked loss.&quot;</span><span class="p">)</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>                  <span class="n">mask_for_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">target_noise</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span> <span class="c1"># Unmasked</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>             <span class="n">mask_for_loss</span> <span class="o">=</span> <span class="n">atom_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># -&gt; [B, N, 1]</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>        <span class="c1"># Ensure prediction shape matches target shape</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>        <span class="k">if</span> <span class="n">stage_d_pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">target_noise</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape mismatch between predicted noise </span><span class="si">{</span><span class="n">stage_d_pred</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and target noise </span><span class="si">{</span><span class="n">target_noise</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>             <span class="c1"># Fallback to zero loss</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>             <span class="n">loss_diffusion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>             <span class="c1"># Calculate masked MSE loss</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a>             <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">stage_d_pred</span> <span class="o">-</span> <span class="n">target_noise</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a>             <span class="n">masked_error</span> <span class="o">=</span> <span class="n">error</span> <span class="o">*</span> <span class="n">mask_for_loss</span> <span class="c1"># Apply boolean mask</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a>             <span class="n">loss_diffusion</span> <span class="o">=</span> <span class="n">masked_error</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">mask_for_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span> <span class="c1"># Normalize by number of valid atom coordinates</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loss Diffusion (Noise MSE): </span><span class="si">{</span><span class="n">loss_diffusion</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a>    <span class="k">elif</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="s1">&#39;coords&#39;</span><span class="p">:</span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating coordinate prediction loss (AF3-style - Placeholder MSE)&quot;</span><span class="p">)</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a>        <span class="n">target_coords</span> <span class="o">=</span> <span class="n">coords_true</span> <span class="c1"># Ground truth coordinates</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>        <span class="c1"># --- Placeholder: Implement AF3 Loss Here ---</span>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>        <span class="c1"># Requires:</span>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a>        <span class="c1"># 1. weighted_rigid_align function (from AF3 supplement Algo 28)</span>
<a id="__codelineno-12-44" name="__codelineno-12-44" href="#__codelineno-12-44"></a>        <span class="c1"># 2. Atom weights wl (from AF3 Eq 4 - needs atom type info)</span>
<a id="__codelineno-12-45" name="__codelineno-12-45" href="#__codelineno-12-45"></a>        <span class="c1"># 3. weighted_mse loss</span>
<a id="__codelineno-12-46" name="__codelineno-12-46" href="#__codelineno-12-46"></a>        <span class="c1"># 4. SmoothLDDTLoss function (from AF3 supplement Algo 27)</span>
<a id="__codelineno-12-47" name="__codelineno-12-47" href="#__codelineno-12-47"></a>        <span class="c1"># 5. sigma_data from config</span>
<a id="__codelineno-12-48" name="__codelineno-12-48" href="#__codelineno-12-48"></a>        <span class="c1"># 6. Weight factor based on sigma_t (from AF3 Eq 6)</span>
<a id="__codelineno-12-49" name="__codelineno-12-49" href="#__codelineno-12-49"></a>
<a id="__codelineno-12-50" name="__codelineno-12-50" href="#__codelineno-12-50"></a>        <span class="c1"># Simplified Placeholder: Masked MSE on *unaligned* coordinates (less accurate)</span>
<a id="__codelineno-12-51" name="__codelineno-12-51" href="#__codelineno-12-51"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using simplified coordinate MSE loss (NO ALIGNMENT). Implement AF3 loss for best results.&quot;</span><span class="p">)</span>
<a id="__codelineno-12-52" name="__codelineno-12-52" href="#__codelineno-12-52"></a>        <span class="n">mask_for_loss</span> <span class="o">=</span> <span class="n">atom_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># [B, N, 1]</span>
<a id="__codelineno-12-53" name="__codelineno-12-53" href="#__codelineno-12-53"></a>        <span class="k">if</span> <span class="n">stage_d_pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">target_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
<a id="__codelineno-12-54" name="__codelineno-12-54" href="#__codelineno-12-54"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape mismatch between predicted coords </span><span class="si">{</span><span class="n">stage_d_pred</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and target coords </span><span class="si">{</span><span class="n">target_coords</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-12-55" name="__codelineno-12-55" href="#__codelineno-12-55"></a>             <span class="n">loss_diffusion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-12-56" name="__codelineno-12-56" href="#__codelineno-12-56"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-12-57" name="__codelineno-12-57" href="#__codelineno-12-57"></a>             <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="n">stage_d_pred</span> <span class="o">-</span> <span class="n">target_coords</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-12-58" name="__codelineno-12-58" href="#__codelineno-12-58"></a>             <span class="n">masked_error</span> <span class="o">=</span> <span class="n">error</span> <span class="o">*</span> <span class="n">mask_for_loss</span>
<a id="__codelineno-12-59" name="__codelineno-12-59" href="#__codelineno-12-59"></a>             <span class="n">loss_diffusion</span> <span class="o">=</span> <span class="n">masked_error</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">mask_for_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
<a id="__codelineno-12-60" name="__codelineno-12-60" href="#__codelineno-12-60"></a>
<a id="__codelineno-12-61" name="__codelineno-12-61" href="#__codelineno-12-61"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loss Diffusion (Coord MSE - No Align): </span><span class="si">{</span><span class="n">loss_diffusion</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-12-62" name="__codelineno-12-62" href="#__codelineno-12-62"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-12-63" name="__codelineno-12-63" href="#__codelineno-12-63"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Internal error: Unknown prediction_type &#39;</span><span class="si">{</span><span class="n">prediction_type</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-12-64" name="__codelineno-12-64" href="#__codelineno-12-64"></a>        <span class="n">loss_diffusion</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Dummy grad</span>
<a id="__codelineno-12-65" name="__codelineno-12-65" href="#__codelineno-12-65"></a>
<a id="__codelineno-12-66" name="__codelineno-12-66" href="#__codelineno-12-66"></a><span class="c1"># Ensure loss requires grad if Stage D requires grad</span>
<a id="__codelineno-12-67" name="__codelineno-12-67" href="#__codelineno-12-67"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">loss_diffusion</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">and</span> <span class="n">stage_d_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stage_d_pred</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
<a id="__codelineno-12-68" name="__codelineno-12-68" href="#__codelineno-12-68"></a>     <span class="n">loss_diffusion</span> <span class="o">=</span> <span class="n">loss_diffusion</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-12-69" name="__codelineno-12-69" href="#__codelineno-12-69"></a>
<a id="__codelineno-12-70" name="__codelineno-12-70" href="#__codelineno-12-70"></a><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Diffusion Loss Calculation Complete: loss=</span><span class="si">{</span><span class="n">loss_diffusion</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</code></pre></div></li>
<li><strong>Critical Considerations:</strong><ul>
<li><strong>Loss Choice:</strong> Noise prediction loss is significantly simpler to implement than the full AF3 coordinate loss. Start with noise prediction unless the <code>ProtenixDiffusionManager</code> is specifically designed <em>only</em> for coordinate prediction.</li>
<li><strong>Masking:</strong> Correctly applying <code>atom_mask</code> is essential. Ensure its shape is broadcastable to the error tensor before multiplication and normalization.</li>
<li><strong>AF3 Loss Implementation:</strong> If implementing the coordinate loss, <code>weighted_rigid_align</code> and <code>SmoothLDDTLoss</code> are non-trivial and must be implemented correctly based on the AF3 supplement. Atom type information is needed for <code>wl</code>. The noise-level weighting (<code>weight_factor</code>) is also important.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Action 5.2:</strong> Verification of Gradient Flow.</p>
<ul>
<li><strong>Details:</strong> Perform the gradient check meticulously.</li>
<li><strong>Procedure:</strong><ol>
<li>Ensure <code>self.stageD</code> and relevant parts of <code>self.stageB_pairformer</code> and <code>self.stageB_torsion</code> (e.g., LoRA adapters if used) have <code>requires_grad=True</code>. Freeze other parts if necessary (<code>self.stageA</code>, base weights of LoRA models).</li>
<li>In <code>training_step</code>, temporarily set <code>total_loss = loss_diffusion</code>.</li>
<li>Run <code>trainer.fit(model, dataloader, max_steps=1)</code>.</li>
<li>Iterate through <code>model.stageD.named_parameters()</code>: Check <code>p.grad is not None</code> and <code>p.grad.abs().sum() &gt; 0</code>.</li>
<li>Iterate through relevant conditioning parameters (e.g., <code>model.stageB_pairformer.lora_params()</code>, <code>model.stageB_torsion.lora_params()</code>, <code>model.latent_merger.parameters()</code>): Check <code>p.grad is not None</code> and <code>p.grad.abs().sum() &gt; 0</code>.</li>
</ol>
</li>
<li><strong>Debugging Missing Gradients:</strong><ul>
<li>Check for <code>.detach()</code> calls anywhere in the path from conditioning inputs -&gt; Stage D -&gt; loss.</li>
<li>Ensure the <code>conditioning_signal</code> passed to Stage D is correctly derived from trainable upstream modules.</li>
<li>Verify <code>run_stageD</code> preserves the computation graph when in training mode.</li>
<li>Check the diffusion loss calculation maintains the graph connection to <code>stage_d_pred</code>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr />
<p><strong>Final Checkpoints for Phase 2:</strong></p>
<ol>
<li><strong>Data Flow Confirmed:</strong> Stage B outputs -&gt; Bridging -&gt; Conditioning Signal -&gt; Stage D -&gt; Prediction (<code>stage_d_pred</code>).</li>
<li><strong>Stage D Training Mode:</strong> <code>run_stageD</code> or equivalent must correctly execute the <em>training</em> step of the diffusion model, using <code>coords_noisy</code> and <code>sigma_t</code>, and returning the appropriate prediction (noise or denoised coords).</li>
<li><strong>Loss Function Correctness:</strong> The chosen diffusion loss (<code>L_diffusion</code>) must match the <code>prediction_type</code> returned by Stage D and correctly use the target (<code>epsilon</code> or <code>coords_true</code>) and <code>atom_mask</code>.</li>
<li><strong>Gradient Propagation Verified:</strong> Gradients from <code>L_diffusion</code> must successfully reach parameters in Stage D <em>and</em> the upstream modules providing the conditioning signal.</li>
</ol>
<h1 id="completing-these-steps-thoroughly-is-essential-for-successfully-training-the-stage-d-component-and-enabling-end-to-end-learning-driven-by-the-diffusion-process">Completing these steps thoroughly is essential for successfully training the Stage D component and enabling end-to-end learning driven by the diffusion process.</h1>
<p>Okay, let's perform a deep dive into the inputs required for the Stage D diffusion process in the <code>RNA_PREDICT</code> pipeline, paying close attention to the role of Stage A's input embedding.</p>
<p><strong>1. Stage D Overview</strong></p>
<p>Stage D (<code>rna_predict/pipeline/stageD/</code>) is responsible for refining the 3D coordinates of the RNA structure, likely starting from coordinates generated by Stage C. It employs a diffusion model, inspired by techniques like those in AlphaFold 3, which iteratively denoises coordinates conditioned on various structural and sequence features.</p>
<p><strong>2. Main Entry Point and Top-Level Inputs (<code>run_stageD_unified.py</code>)</strong></p>
<p>The primary entry point seems to be <code>run_stageD_diffusion</code> within <code>run_stageD_unified.py</code>. This function expects a configuration object, specifically an instance of <code>DiffusionConfig</code> (defined in <code>rna_predict/pipeline/stageD/diffusion/utils/config_types.py</code>), which bundles the main inputs:</p>
<ul>
<li><strong><code>partial_coords</code> (torch.Tensor):</strong> The initial 3D coordinates to be refined. These likely come from Stage C's reconstruction. Crucially, the diffusion model itself (<code>DiffusionModule</code>) operates at the <strong>atom level</strong>. Shape is expected to be <code>[Batch, N_atom, 3]</code>.</li>
<li><strong><code>trunk_embeddings</code> (Dict[str, torch.Tensor]):</strong> A dictionary containing core feature embeddings. These are expected <em>before</em> the bridging step and are likely <strong>residue-level</strong>. The bridging function converts them to atom-level. Key embeddings typically include:<ul>
<li><code>s_trunk</code>: Single representation from upstream (e.g., Pairformer in Stage B). Expected shape <em>before</em> bridging: <code>[Batch, N_residue, C_s]</code>.</li>
<li><code>s_inputs</code>: Single representation derived from input features (potentially including Stage A output). Expected shape <em>before</em> bridging: <code>[Batch, N_residue, C_s_inputs]</code>.</li>
<li><code>pair</code> (or <code>z_trunk</code>): Pair representation from upstream (e.g., Pairformer). Expected shape <em>before</em> bridging: <code>[Batch, N_residue, N_residue, C_z]</code>.</li>
</ul>
</li>
<li><strong><code>diffusion_config</code> (DictConfig / Dict):</strong> A nested configuration structure containing parameters specific to the diffusion process itself (noise schedule, inference steps, model architecture details, etc.).</li>
<li><strong><code>input_features</code> (Optional[Dict[str, Any]]):</strong> A dictionary containing various other input features, potentially a mix of atom-level and residue-level data <em>before</em> bridging. The bridging step standardizes these. Important keys include:<ul>
<li><code>atom_metadata</code>: Contains <code>residue_indices</code>, <code>atom_names</code>, etc. Crucial for mapping atoms to residues.</li>
<li><code>ref_element</code>, <code>ref_atom_name_chars</code>, <code>ref_charge</code>, <code>ref_mask</code>: Atom-level reference features.</li>
<li><code>restype</code>, <code>profile</code>: Residue-level features.</li>
<li><code>sequence</code>: The RNA sequence string.</li>
</ul>
</li>
<li><strong><code>mode</code> (str):</strong> "inference" or "train".</li>
<li><strong><code>device</code> (str):</strong> "cpu", "cuda", or "mps".</li>
<li><strong><code>debug_logging</code> (bool):</strong> Controls logging level.</li>
<li><strong><code>cfg</code> (DictConfig):</strong> The overall Hydra configuration object, passed down for accessing various parameters.</li>
<li><strong><code>atom_metadata</code> (Optional[Dict[str, Any]]):</strong> Explicitly passed metadata (overlaps with <code>input_features</code>). Required for bridging.</li>
</ul>
<p><strong>3. The Crucial Bridging Step (<code>bridging/residue_atom_bridge.py</code>)</strong></p>
<p>Before the core diffusion model (<code>DiffusionModule</code>) sees the inputs, the <code>bridge_residue_to_atom</code> function is called within <code>run_stageD_unified.py</code>. This is a critical step:</p>
<ul>
<li><strong>Input:</strong> Takes <code>BridgingInput</code> containing the <em>residue-level</em> <code>trunk_embeddings</code> (<code>s_trunk</code>, <code>s_inputs</code>, <code>pair</code>/<code>z_trunk</code>), <code>partial_coords</code> (atom-level), <code>input_features</code>, and <code>sequence</code>.</li>
<li><strong>Process:</strong><ul>
<li>Uses <code>atom_metadata</code> (specifically <code>residue_indices</code>) to create or validate a <code>residue_atom_map</code>.</li>
<li>Calls <code>process_trunk_embeddings</code>: Expands the <strong>residue-level</strong> <code>s_trunk</code>, <code>s_inputs</code>, and <code>pair</code>/<code>z_trunk</code> embeddings into <strong>atom-level</strong> embeddings using the map. For example, <code>s_trunk</code> <code>[B, N_residue, C]</code> becomes <code>[B, N_atom, C]</code>. <code>pair</code> <code>[B, N_residue, N_residue, C]</code> becomes <code>[B, N_atom, N_atom, C]</code>.</li>
<li>Calls <code>process_input_features</code>: Ensures other features (like <code>restype</code>, <code>profile</code>) are expanded to the atom level and creates the essential <code>atom_to_token_idx</code> tensor (mapping each atom to its residue index).</li>
</ul>
</li>
<li><strong>Output:</strong> Returns atom-level <code>partial_coords</code>, atom-level <code>trunk_embeddings</code>, and atom-level <code>input_features</code>.</li>
</ul>
<p><strong>Therefore, the inputs <em>directly</em> consumed by the core diffusion machinery (<code>ProtenixDiffusionManager</code> -&gt; <code>DiffusionModule</code>) are primarily at the atom level, having been transformed by this bridging step.</strong></p>
<p><strong>4. Core Diffusion Inputs (<code>ProtenixDiffusionManager</code> &amp; <code>DiffusionModule</code>)</strong></p>
<p>The <code>ProtenixDiffusionManager</code> orchestrates the diffusion steps, calling the <code>DiffusionModule</code>. The <em>effective</em> inputs to the <code>DiffusionModule</code> (after bridging and internal processing by the manager/conditioning layers) are:</p>
<ul>
<li><strong><code>x_noisy</code> (torch.Tensor):</strong> Noisy atom coordinates. Shape <code>[Batch, N_sample, N_atom, 3]</code>. Derived from the initial <code>partial_coords</code>.</li>
<li><strong><code>t_hat_noise_level</code> (torch.Tensor):</strong> The noise level for the current step. Shape <code>[Batch, N_sample]</code> or broadcastable.</li>
<li><strong><code>input_feature_dict</code> (Dict[str, Any]):</strong> Contains <em>atom-level</em> features after bridging. Crucially includes:<ul>
<li><code>atom_to_token_idx</code>: Map from atom index to residue index. Shape <code>[Batch, N_atom]</code>.</li>
<li><code>ref_pos</code>: Reference positions (can be the initial <code>partial_coords</code>). Shape <code>[Batch, N_atom, 3]</code>.</li>
<li><code>ref_mask</code>: Mask indicating valid atoms. Shape <code>[Batch, N_atom, 1]</code>.</li>
<li><code>ref_element</code>, <code>ref_atom_name_chars</code>, <code>ref_charge</code>: Atom properties.</li>
<li><code>restype</code>, <code>profile</code>: Residue-level features <em>broadcasted to the atom level</em>.</li>
</ul>
</li>
<li><strong><code>s_inputs</code> (torch.Tensor):</strong> Single representation derived from input features, now at the <strong>atom level</strong>. Shape <code>[Batch, N_sample, N_atom, C_s_inputs]</code>.</li>
<li><strong><code>s_trunk</code> (torch.Tensor):</strong> Single representation from upstream stages, now at the <strong>atom level</strong>. Shape <code>[Batch, N_sample, N_atom, C_s]</code>.</li>
<li><strong><code>z_trunk</code> (torch.Tensor):</strong> Pair representation from upstream stages, now at the <strong>atom level</strong>. Shape <code>[Batch, N_sample, N_atom, N_atom, C_z]</code>. (Note: Referred to as <code>pair</code> in some parts of the bridging code, but likely corresponds to <code>z_trunk</code> conceptually).</li>
<li><strong><code>unified_latent</code> (Optional[torch.Tensor]):</strong> An optional conditioning vector potentially combining information from multiple upstream stages (A, B, C). Its exact processing depends on how <code>DiffusionConditioning</code> uses it.</li>
</ul>
<p><strong>5. The Role of Stage A Input Embedding</strong></p>
<p>Now, let's address the connection to Stage A's input embedding:</p>
<ul>
<li><strong>Stage A Output:</strong> The <code>InputFeatureEmbedder</code> (in <code>rna_predict/pipeline/stageA/input_embedding/current/embedders.py</code>), which uses the <code>AtomAttentionEncoder</code>, processes atom features (like element type, charge) and produces a <strong>token-level (residue-level)</strong> embedding. Its output dimension is <code>c_token</code>.</li>
<li><strong>Indirect Connection:</strong> This Stage A output <em>does not directly feed</em> into the core Stage D <code>DiffusionModule</code> which operates at the atom level.</li>
<li><strong>How it Feeds In:</strong> The token-level embedding produced by Stage A likely contributes to one or both of the <strong>residue-level</strong> <code>trunk_embeddings</code> (<code>s_trunk</code>, <code>s_inputs</code>) <em>before</em> they are passed to the Stage D bridging function.<ul>
<li>It might be directly used as <code>s_inputs</code> (residue-level).</li>
<li>It might be passed to Stage B (e.g., Pairformer) which then produces the <code>s_trunk</code> and <code>pair</code>/<code>z_trunk</code> embeddings (still residue-level).</li>
</ul>
</li>
<li><strong>Transformation:</strong> The key is that the residue-level information, potentially influenced by Stage A's output, is explicitly converted to the atom-level representations required by Stage D's <code>DiffusionModule</code> via the <code>bridge_residue_to_atom</code> function.</li>
</ul>
<p><strong>In Summary:</strong></p>
<p>Stage D diffusion requires <strong>atom-level</strong> inputs:</p>
<ol>
<li><strong>Initial/Noisy Atom Coordinates:</strong> (<code>partial_coords</code> -&gt; <code>x_noisy</code>)</li>
<li><strong>Atom-Level Single Embeddings:</strong> (<code>s_trunk</code>, <code>s_inputs</code> <em>after</em> bridging) - These originated as residue-level embeddings potentially derived from Stage A/B/C outputs.</li>
<li><strong>Atom-Level Pair Embeddings:</strong> (<code>pair</code>/<code>z_trunk</code> <em>after</em> bridging) - Originated as residue-level embeddings from Stage B/C.</li>
<li><strong>Atom-Level Reference Features:</strong> (<code>ref_mask</code>, <code>ref_element</code>, etc. from <code>input_features</code> <em>after</em> bridging).</li>
<li><strong>Atom-to-Residue Mapping:</strong> (<code>atom_to_token_idx</code> from <code>input_features</code> <em>after</em> bridging).</li>
<li><strong>Noise Level:</strong> (<code>t_hat_noise_level</code>).</li>
<li><strong>Optional Unified Latent Conditioning:</strong> (From merger).</li>
</ol>
<h1 id="stage-as-input-embedding-produces-residue-level-features-these-features-influence-the-residue-level-trunk_embeddings-passed-into-the-stage-d-module-but-they-must-first-be-transformed-into-atom-level-representations-by-the-crucial-bridging-step-bridge_residue_to_atom-before-being-consumed-by-the-core-atom-level-diffusion-model-diffusionmodule">Stage A's input embedding produces residue-level features. These features influence the residue-level <code>trunk_embeddings</code> passed <em>into</em> the Stage D module, but they must first be transformed into atom-level representations by the crucial bridging step (<code>bridge_residue_to_atom</code>) before being consumed by the core atom-level diffusion model (<code>DiffusionModule</code>).</h1>
<p>Okay, let's perform a deep dive into <strong>Phase 3: Final Integration</strong>, focusing on combining the losses, reviewing configurations, and establishing a robust testing strategy.</p>
<p><strong>Goal:</strong> Finalize the <code>RNALightningModule.training_step</code> by combining the angle and diffusion losses, ensure the entire configuration is consistent (especially dimensions), and define tests to verify end-to-end gradient flow and training stability.</p>
<hr />
<p><strong>6. File: <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule</code>) - Combine and Log Losses</strong></p>
<ul>
<li>
<p><strong>Action 6.1: Define Loss Weights in Configuration.</strong></p>
<ul>
<li><strong>Rationale:</strong> Loss weights should be configurable hyperparameters for easy tuning.</li>
<li><strong>File:</strong> <code>rna_predict/conf/config_schema.py</code><ul>
<li><strong>Action:</strong> Add a <code>TrainingConfig</code> dataclass (if not already present) to hold training-specific hyperparameters like loss weights.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># ... other imports ...</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="nd">@dataclass</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">TrainingConfig</span><span class="p">:</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for training-related parameters.&quot;&quot;&quot;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="n">checkpoint_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;outputs/checkpoints&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Directory to save checkpoints&quot;</span><span class="p">})</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>    <span class="n">w_diffusion</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Weight for the diffusion loss term&quot;</span><span class="p">})</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>    <span class="n">w_angle</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="s2">&quot;Weight for the direct angle loss term&quot;</span><span class="p">})</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>    <span class="c1"># Add other training params like learning_rate, epochs etc. if managing them here</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="c1"># ... Add TrainingConfig to the main RNAConfig ...</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="nd">@dataclass</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">RNAConfig</span><span class="p">:</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="c1"># ... other fields ...</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>    <span class="n">training</span><span class="p">:</span> <span class="n">TrainingConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">TrainingConfig</span><span class="p">)</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>    <span class="c1"># ... other fields ...</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="c1"># ... Add TrainingConfig registration in register_configs() ...</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">register_configs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>    <span class="c1"># ... other cs.store calls ...</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>    <span class="n">cs</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">TrainingConfig</span><span class="p">)</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>    <span class="c1"># ...</span>
</code></pre></div></li>
</ul>
</li>
<li><strong>File:</strong> Create <code>rna_predict/conf/training/default.yaml</code><ul>
<li><strong>Action:</strong> Define the default weights.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># rna_predict/conf/training/default.yaml</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">_self_</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="nt">checkpoint_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">outputs/checkpoints</span><span class="w"> </span><span class="c1"># Default checkpoint dir</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="nt">w_diffusion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="nt">w_angle</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="c1"># Add other training defaults (e.g., learning_rate: 0.001)</span>
</code></pre></div></li>
</ul>
</li>
<li><strong>File:</strong> <code>rna_predict/conf/default.yaml</code><ul>
<li><strong>Action:</strong> Ensure the training config group is included in the main defaults list.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># rna_predict/conf/default.yaml</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">_self_</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">model/stageA@model.stageA</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">  </span><span class="c1"># ... other model stages ...</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">training</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"> </span><span class="c1"># &lt;&lt;&lt; ADD THIS LINE</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_data@test_data</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="c1"># ... rest of the file ...</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Action 6.2: Calculate Combined Loss in <code>training_step</code>.</strong></p>
<ul>
<li><strong>File:</strong> <code>rna_predict/training/rna_lightning_module.py</code> (<code>RNALightningModule.training_step</code>)</li>
<li><strong>Action:</strong> Combine <code>loss_angle</code> and <code>loss_diffusion</code> using weights from <code>self.cfg.training</code>. Handle cases where a loss might not have been computed (e.g., <code>load_ang=False</code>).</li>
<li><strong>Code Snippet (End of <code>training_step</code>):</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># (Assuming loss_angle and loss_diffusion are calculated above if enabled/successful)</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="c1"># Initialize total loss</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">total_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device_</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Start with a zero tensor that requires grad</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="c1"># Access weights safely with defaults</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="n">w_diffusion</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="s1">&#39;w_diffusion&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">w_angle</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="s1">&#39;training&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="s1">&#39;w_angle&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="c1"># Add diffusion loss if computed</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="n">diffusion_loss_computed</span> <span class="o">=</span> <span class="s1">&#39;loss_diffusion&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">loss_diffusion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">loss_diffusion</span><span class="p">)</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="k">if</span> <span class="n">diffusion_loss_computed</span><span class="p">:</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="c1"># Ensure loss_diffusion requires grad if its inputs did</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">loss_diffusion</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">and</span> <span class="s1">&#39;stage_d_pred&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">stage_d_pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stage_d_pred</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>         <span class="n">loss_diffusion</span> <span class="o">=</span> <span class="n">loss_diffusion</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>    <span class="k">if</span> <span class="n">w_diffusion</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>         <span class="n">total_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">+</span> <span class="n">w_diffusion</span> <span class="o">*</span> <span class="n">loss_diffusion</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>         <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;train/loss_diffusion&#39;</span><span class="p">,</span> <span class="n">loss_diffusion</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sync_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>         <span class="c1"># Log zero if weight is zero but loss was computed</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>         <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;train/loss_diffusion&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sync_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="c1"># Add angle loss if computed (depends on load_ang and successful calculation)</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="n">angle_loss_computed</span> <span class="o">=</span> <span class="s1">&#39;loss_angle&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">loss_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">loss_angle</span><span class="p">)</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="k">if</span> <span class="n">angle_loss_computed</span><span class="p">:</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>     <span class="c1"># Ensure loss_angle requires grad if its inputs did</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>     <span class="k">if</span> <span class="ow">not</span> <span class="n">loss_angle</span><span class="o">.</span><span class="n">requires_grad</span> <span class="ow">and</span> <span class="s1">&#39;output&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;torsion_angles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>          <span class="n">loss_angle</span> <span class="o">=</span> <span class="n">loss_angle</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>     <span class="k">if</span> <span class="n">w_angle</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>          <span class="n">total_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">+</span> <span class="n">w_angle</span> <span class="o">*</span> <span class="n">loss_angle</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>          <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;train/loss_angle&#39;</span><span class="p">,</span> <span class="n">loss_angle</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sync_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>     <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>         <span class="c1"># Log zero if weight is zero but loss was computed</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>         <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;train/loss_angle&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sync_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="c1"># Log total loss</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;train/loss&#39;</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">,</span> <span class="n">on_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prog_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sync_dist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a><span class="c1"># Return the total loss for the optimizer</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a><span class="k">return</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">total_loss</span><span class="p">}</span>
</code></pre></div></li>
<li><strong>Critical Considerations:</strong><ul>
<li>Gradient Requirement: Ensure <code>total_loss</code> retains <code>requires_grad=True</code> if any component loss had it. Starting <code>total_loss</code> as a zero tensor with <code>requires_grad=True</code> helps if the first added loss term happens to be zero but had graph history. Cloning component losses before adding might also be necessary if they were potentially modified in-place during logging.</li>
<li>Logging: Use <code>sync_dist=True</code> for distributed training environments.</li>
<li>Zero Weights: The logic handles cases where a weight is zero, ensuring the corresponding component isn't added to <code>total_loss</code> but is still logged (as 0.0) for monitoring consistency.</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr />
<p><strong>7. File: <code>rna_predict/conf/**</code> - Configuration &amp; Dimension Review</strong></p>
<ul>
<li>
<p><strong>Action 7.1: Establish Central Dimension Definitions.</strong></p>
<ul>
<li><strong>File:</strong> <code>rna_predict/conf/config_schema.py</code></li>
<li><strong>Action:</strong> Define a <code>DimensionsConfig</code> dataclass to hold shared dimensions.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DimensionsConfig</span><span class="p">:</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Centralized dimensions for consistency across stages.&quot;&quot;&quot;</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="c1"># --- Stage B / Pairformer Output ---</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="n">c_s</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">384</span>  <span class="c1"># Single representation dimension (Pairformer -&gt; Merger -&gt; Stage D)</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="n">c_z</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>  <span class="c1"># Pair representation dimension (Pairformer -&gt; Merger -&gt; Stage D)</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    <span class="c1"># --- Stage B / TorsionBERT Output ---</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="n">num_angles</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span> <span class="c1"># Standard torsions (alpha-zeta, chi)</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="n">angle_rep_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Calculated: 7 or 14</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="c1"># --- Stage D Conditioning / Internal ---</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="n">c_s_inputs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">449</span> <span class="c1"># Dimension of initial token features (InputFeatureEmbedder output)</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="n">c_token</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">768</span> <span class="c1"># Token dimension within Stage D Transformer</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="n">c_atom</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span> <span class="c1"># Atom embedding dimension within Stage D</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="n">c_atompair</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span> <span class="c1"># Atom pair embedding dimension within Stage D</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>    <span class="n">c_noise_embedding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># Noise level embedding dimension</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>    <span class="c1"># --- Latent Merger ---</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>    <span class="n">latent_merger_hidden_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span> <span class="c1"># Example hidden dim for merger MLP/Transformer</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>    <span class="n">latent_merger_output_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span> <span class="c1"># Example output dim for unified latent</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>         <span class="c1"># Example: calculate angle_rep_dim based on TorsionBERT config (needs access to it)</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>         <span class="c1"># This is tricky with pure dataclasses. Better to handle in RNALightningModule __init__</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>         <span class="c1"># Or require angle_mode to be passed here. Let&#39;s assume 14 for sin/cos default.</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>         <span class="bp">self</span><span class="o">.</span><span class="n">angle_rep_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_angles</span> <span class="o">*</span> <span class="mi">2</span> <span class="c1"># Default assumes sin/cos output</span>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="c1"># Add DimensionsConfig registration</span>
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="k">def</span><span class="w"> </span><span class="nf">register_configs</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>     <span class="c1"># ... other registrations ...</span>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>     <span class="n">cs</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s2">&quot;dimensions&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">DimensionsConfig</span><span class="p">)</span>
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a><span class="c1"># In RNAConfig:</span>
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="nd">@dataclass</span>
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a><span class="k">class</span><span class="w"> </span><span class="nc">RNAConfig</span><span class="p">:</span>
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>     <span class="c1"># ...</span>
<a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>     <span class="n">dimensions</span><span class="p">:</span> <span class="n">DimensionsConfig</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">DimensionsConfig</span><span class="p">)</span>
<a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>     <span class="c1"># ...</span>
</code></pre></div></li>
<li><strong>File:</strong> <code>rna_predict/conf/dimensions/default.yaml</code> (New file)
    <div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># Default dimension values</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nt">c_s</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">384</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="nt">c_z</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="nt">num_angles</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="nt">c_s_inputs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">449</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="nt">c_token</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">768</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="nt">c_atom</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">128</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="nt">c_atompair</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">16</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="nt">c_noise_embedding</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="nt">latent_merger_hidden_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">256</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="nt">latent_merger_output_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">512</span>
</code></pre></div></li>
<li><strong>File:</strong> <code>rna_predict/conf/default.yaml</code>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">_self_</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"> </span><span class="c1"># &lt;&lt;&lt; ADD THIS</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">  </span><span class="c1"># ... model stages ...</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">training</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_data@test_data</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p><strong>Action 7.2: Use Interpolation in Stage YAMLs.</strong></p>
<ul>
<li><strong>Rationale:</strong> Link stage-specific dimensions back to the central <code>dimensions</code> config group.</li>
<li><strong>Example (<code>rna_predict/conf/model/stageB_pairformer.yaml</code>):</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># Core model parameters</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="nt">n_blocks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">48</span><span class="w"> </span><span class="c1"># Example specific value</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="nt">n_heads</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span><span class="w">   </span><span class="c1"># Example specific value</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="nt">c_z</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_z}</span><span class="w">          </span><span class="c1"># Interpolated</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="nt">c_s</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_s}</span><span class="w">          </span><span class="c1"># Interpolated</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="c1"># ... other pairformer params ...</span>
</code></pre></div></li>
<li><strong>Example (<code>rna_predict/conf/model/stageD_diffusion.yaml</code>):</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># ... other diffusion keys ...</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nt">model_architecture</span><span class="p">:</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">  </span><span class="nt">c_s</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_s}</span><span class="w">          </span><span class="c1"># Interpolated</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span><span class="nt">c_z</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_z}</span><span class="w">          </span><span class="c1"># Interpolated</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">  </span><span class="nt">c_s_inputs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_s_inputs}</span><span class="w"> </span><span class="c1"># Interpolated</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">  </span><span class="nt">c_token</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_token}</span><span class="w">    </span><span class="c1"># Interpolated</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">  </span><span class="nt">c_atom</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_atom}</span><span class="w">      </span><span class="c1"># Interpolated</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">  </span><span class="nt">c_atompair</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_atompair}</span><span class="w"> </span><span class="c1"># Interpolated</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">  </span><span class="nt">c_noise_embedding</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_noise_embedding}</span><span class="w"> </span><span class="c1"># Interpolated</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">  </span><span class="nt">sigma_data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span><span class="w"> </span><span class="c1"># Example specific value</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="c1"># ... other model_arch keys ...</span>
</code></pre></div></li>
<li><strong>Example (<code>rna_predict/conf/model/latent_merger.yaml</code> - If created):</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">_self_</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="nt">merge_method</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;concat&quot;</span><span class="w"> </span><span class="c1"># Example</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="nt">angle_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.angle_rep_dim}</span><span class="w"> </span><span class="c1"># Interpolated (Needs calculation logic)</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="nt">s_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_s}</span><span class="w">             </span><span class="c1"># Interpolated</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="nt">z_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.c_z}</span><span class="w">             </span><span class="c1"># Interpolated</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="nt">hidden_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.latent_merger_hidden_dim}</span><span class="w"> </span><span class="c1"># Interpolated</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="nt">output_dim</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${dimensions.latent_merger_output_dim}</span><span class="w"> </span><span class="c1"># Interpolated</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="c1"># ... other merger params ...</span>
</code></pre></div></li>
<li><strong>Action:</strong> Apply this interpolation pattern systematically to all relevant dimension parameters in all stage <code>.yaml</code> files and corresponding <code>config_schema.py</code> dataclasses.</li>
</ul>
</li>
<li>
<p><strong>Action 7.3: Verify Bridging Logic Dimensions.</strong></p>
<ul>
<li><strong>File:</strong> <code>rna_predict/training/rna_lightning_module.py</code> (<code>training_step</code>)</li>
<li><strong>Action:</strong> When preparing the <code>conditioning_signal</code> for Stage D, ensure the expected dimensions match those defined in <code>cfg.dimensions</code>.<ul>
<li>Check <code>s_embeddings_atom</code> has feature dim <code>cfg.dimensions.c_s</code>.</li>
<li>Check <code>z_embeddings_res</code> (or <code>z_embeddings_atom</code>) has feature dim <code>cfg.dimensions.c_z</code>.</li>
<li>If using <code>unified_latent</code>, ensure its dimension matches <code>cfg.dimensions.latent_merger_output_dim</code> and that Stage D conditioning expects this dimension.</li>
</ul>
</li>
<li><strong>File:</strong> <code>rna_predict/pipeline/stageD/diffusion/components/diffusion_conditioning.py</code> (<code>DiffusionConditioning</code>)</li>
<li><strong>Action:</strong> Ensure the dimensions passed during initialization (<code>c_s</code>, <code>c_z</code>, <code>c_s_inputs</code>) are derived from the <em>interpolated</em> config values, ultimately linking back to <code>cfg.dimensions</code>.</li>
</ul>
</li>
<li>
<p><strong>Verification:</strong></p>
<ul>
<li>Run <code>python rna_predict/training/train.py --cfg job</code>. Examine the output YAML. Verify that dimensions like <code>c_s</code>, <code>c_z</code> are identical across <code>model.stageB_pairformer</code>, <code>model.stageD.diffusion.model_architecture</code>, etc.</li>
<li>Instantiate <code>RNALightningModule</code> with the config and print the shapes of internal layers (e.g., <code>self.latent_merger.mlp[0].in_features</code>) to confirm they match the resolved config dimensions.</li>
</ul>
</li>
</ul>
<hr />
<p><strong>8. Testing Strategy</strong></p>
<ul>
<li>
<p><strong>Action 8.1: Unit Tests.</strong></p>
<ul>
<li><strong>Files:</strong> <code>tests/unit/test_losses.py</code>, <code>tests/unit/test_merger.py</code>, <code>tests/unit/test_bridging.py</code>.</li>
<li><strong>Actions:</strong><ul>
<li>Write tests for <code>L_angle</code> calculation: include sin/cos conversion, MSE logic, masking.</li>
<li>Write tests for <code>L_diffusion</code> calculation:<ul>
<li>If noise prediction: test MSE with masking.</li>
<li>If coordinate prediction: unit test <code>weighted_rigid_align</code>, <code>SmoothLDDTLoss</code>, weighted MSE, and the final combination with the <code>sigma_t</code> factor.</li>
</ul>
</li>
<li>Write tests for <code>SimpleLatentMerger</code> (or chosen merger) checking output shape given input shapes matching <code>cfg.dimensions</code>.</li>
<li>Refine tests for <code>residue_to_atoms</code> and bridging logic in <code>training_step</code> to ensure atom-level outputs have correct shapes based on <code>cfg.dimensions</code>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Action 8.2: Integration Test (<code>tests/integration/test_lightning_trainer.py</code>).</strong></p>
<ul>
<li><strong>Setup:</strong><ul>
<li>Use a minimal dataset (1-2 samples with pre-computed angles).</li>
<li>Use a minimal config (<code>test_config.yaml</code>) with small dimensions (e.g., <code>c_s=16, c_z=8</code>), 1 block per stage, <code>load_ang=true</code>, and loss weights <code>w_diffusion=1.0, w_angle=1.0</code>.</li>
</ul>
</li>
<li><strong>Execution:</strong>
    <div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">L</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">hydra</span><span class="w"> </span><span class="kn">import</span> <span class="n">compose</span><span class="p">,</span> <span class="n">initialize</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rna_predict.training.rna_lightning_module</span><span class="w"> </span><span class="kn">import</span> <span class="n">RNALightningModule</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rna_predict.dataset.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">RNADataset</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rna_predict.dataset.collate</span><span class="w"> </span><span class="kn">import</span> <span class="n">rna_collate_fn</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span> <span class="c1"># Mark as slow integration test</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_end_to_end_gradient_flow</span><span class="p">():</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>    <span class="c1"># Assumes test_config.yaml exists and points to minimal data</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    <span class="k">with</span> <span class="n">initialize</span><span class="p">(</span><span class="n">config_path</span><span class="o">=</span><span class="s2">&quot;../../rna_predict/conf&quot;</span><span class="p">,</span> <span class="n">version_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>        <span class="c1"># Compose with minimal overrides for training</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>        <span class="n">cfg</span> <span class="o">=</span> <span class="n">compose</span><span class="p">(</span><span class="n">config_name</span><span class="o">=</span><span class="s2">&quot;test_config.yaml&quot;</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>            <span class="s2">&quot;data.load_ang=true&quot;</span><span class="p">,</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>            <span class="s2">&quot;training.w_diffusion=1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>            <span class="s2">&quot;training.w_angle=1.0&quot;</span><span class="p">,</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>            <span class="s2">&quot;data.batch_size=1&quot;</span><span class="p">,</span> <span class="c1"># Use batch size 1 for easier debugging</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>            <span class="s2">&quot;data.max_res=30&quot;</span><span class="p">,</span> <span class="c1"># Small max length</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>            <span class="c1"># Minimal model dimensions override example</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>            <span class="s2">&quot;dimensions.c_s=16&quot;</span><span class="p">,</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>            <span class="s2">&quot;dimensions.c_z=8&quot;</span><span class="p">,</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>            <span class="s2">&quot;dimensions.c_atom=4&quot;</span><span class="p">,</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>            <span class="s2">&quot;dimensions.c_atompair=2&quot;</span><span class="p">,</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>            <span class="s2">&quot;dimensions.c_token=32&quot;</span><span class="p">,</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>            <span class="s2">&quot;dimensions.c_s_inputs=10&quot;</span><span class="p">,</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>            <span class="s2">&quot;dimensions.c_noise_embedding=4&quot;</span><span class="p">,</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>            <span class="s2">&quot;model.stageB_pairformer.n_blocks=1&quot;</span><span class="p">,</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>            <span class="s2">&quot;model.stageD.diffusion.transformer.n_blocks=1&quot;</span><span class="p">,</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>            <span class="c1"># Ensure Stage D runs in train mode for the test</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>            <span class="s2">&quot;model.stageD.mode=train&quot;</span><span class="p">,</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>            <span class="s2">&quot;model.stageD.diffusion.mode=train&quot;</span><span class="p">,</span>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>        <span class="p">])</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>    <span class="c1"># Setup Model, Dataset, DataLoader</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">RNALightningModule</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">RNADataset</span><span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="n">cfg</span><span class="p">,</span> <span class="n">load_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">load_ang</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>    <span class="c1"># Ensure dataset is not empty</span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>         <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Skipping gradient flow test: Dataset is empty.&quot;</span><span class="p">)</span>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">rna_collate_fn</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>    <span class="c1"># Define parameters to check gradients for</span>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>    <span class="n">params_to_check</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>        <span class="s2">&quot;stageB_torsion&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">stageB_torsion</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>        <span class="s2">&quot;stageB_pairformer&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">stageB_pairformer</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span> <span class="c1"># Check all if not using LoRA</span>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>        <span class="s2">&quot;latent_merger&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">latent_merger</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>        <span class="s2">&quot;stageD&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">stageD</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="c1"># Check diffusion manager/module params</span>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a>    <span class="p">}</span>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a>    <span class="c1"># Filter for trainable params only (requires_grad=True)</span>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>    <span class="n">trainable_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">params_to_check</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a>
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a>    <span class="c1"># Ensure there are trainable parameters before proceeding</span>
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a>    <span class="n">total_trainable</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">trainable_params</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a>    <span class="k">if</span> <span class="n">total_trainable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a>         <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;Skipping gradient flow test: No trainable parameters found in relevant modules.&quot;</span><span class="p">)</span>
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a>    <span class="c1"># Simple Training Loop (instead of Trainer.fit for direct control)</span>
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a>    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span> <span class="c1"># Set model to training mode</span>
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a>    <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a>
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a>    <span class="c1"># --- Manual Training Step ---</span>
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a>    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a>    <span class="n">loss_dict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">training_step</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># Get loss dict { &quot;loss&quot;: total_loss }</span>
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a>    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">loss_dict</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span>
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a>    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">is_tensor</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">total_loss</span><span class="p">),</span> <span class="s2">&quot;Loss is NaN or not a tensor&quot;</span>
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a>    <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a>    <span class="c1"># --- End Manual Step ---</span>
<a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a>
<a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a>    <span class="c1"># Check Gradients</span>
<a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Checking Gradients ---&quot;</span><span class="p">)</span>
<a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a>    <span class="n">all_grads_present</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">trainable_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a>        <span class="n">has_grad</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">)</span>
<a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, Trainable Params: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">, Has Non-Zero Grad: </span><span class="si">{</span><span class="n">has_grad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
<a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a>             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  (No trainable params found for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">has_grad</span><span class="p">:</span>
<a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a>            <span class="n">all_grads_present</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-23-82" name="__codelineno-23-82" href="#__codelineno-23-82"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  WARNING: No gradients flowed to trainable parameters in </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
<a id="__codelineno-23-83" name="__codelineno-23-83" href="#__codelineno-23-83"></a>            <span class="c1"># Optional: Print grad norms for debugging</span>
<a id="__codelineno-23-84" name="__codelineno-23-84" href="#__codelineno-23-84"></a>            <span class="c1"># for i, p in enumerate(params):</span>
<a id="__codelineno-23-85" name="__codelineno-23-85" href="#__codelineno-23-85"></a>            <span class="c1">#     print(f&quot;    Param {i}: grad={p.grad.abs().sum().item() if p.grad is not None else None}&quot;)</span>
<a id="__codelineno-23-86" name="__codelineno-23-86" href="#__codelineno-23-86"></a>
<a id="__codelineno-23-87" name="__codelineno-23-87" href="#__codelineno-23-87"></a>    <span class="k">assert</span> <span class="n">all_grads_present</span><span class="p">,</span> <span class="s2">&quot;Gradients did not flow back to all expected trainable components (TorsionBERT, Pairformer, Merger, StageD).&quot;</span>
<a id="__codelineno-23-88" name="__codelineno-23-88" href="#__codelineno-23-88"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Gradient Check Passed ---&quot;</span><span class="p">)</span>
</code></pre></div></li>
<li><strong>Action:</strong> Run this integration test. Debug any assertion failures related to missing gradients or NaN losses.</li>
</ul>
</li>
<li>
<p><strong>Action 8.3: Training Monitoring.</strong></p>
<ul>
<li><strong>Setup:</strong><ul>
<li>Use a representative subset of data (e.g., 100-500 structures).</li>
<li>Configure <code>lightning.pytorch.loggers.TensorBoardLogger</code>.</li>
<li>Set <code>Trainer(logger=tb_logger, max_epochs=10)</code>.</li>
</ul>
</li>
<li><strong>Execution:</strong> Run <code>python rna_predict/training/train.py</code> with appropriate overrides for the dataset subset and logger.</li>
<li><strong>Analysis:</strong> Open TensorBoard (<code>tensorboard --logdir ./lightning_logs</code>). Examine the plots for <code>train/loss</code>, <code>train/loss_diffusion</code>, <code>train/loss_angle</code>. Look for decreasing trends and stability. Experiment with different <code>w_diffusion</code> and <code>w_angle</code> values (e.g., <code>[1.0, 0.0]</code>, <code>[0.0, 1.0]</code>, <code>[1.0, 0.1]</code>, <code>[1.0, 1.0]</code>) in the config to understand their relative impact.</li>
</ul>
</li>
</ul>
<hr />
<p><strong>Summary of Phase 3:</strong></p>
<p>This final phase ensures the components trained in Phases 1 &amp; 2 work together correctly.
1.  <strong>Loss Combination:</strong> Implemented a weighted sum of <code>L_angle</code> and <code>L_diffusion</code> in <code>training_step</code>, controlled by Hydra config. Added robust logging.
2.  <strong>Config Review:</strong> Emphasized using <code>config_schema.py</code> and Hydra interpolation (<code>${dimensions...}</code>) to enforce dimensional consistency across all YAML files and code. Outlined key dimensions to track.
3.  <strong>Testing:</strong> Defined specific unit tests for loss components and bridging, a critical integration test checking end-to-end gradient flow to all trainable modules (TorsionBERT, Pairformer, Merger, StageD), and a strategy for monitoring training stability and loss convergence using TensorBoard.</p>
<h1 id="completing-this-phase-successfully-validates-that-the-entire-trainable-pipeline-stages-b-d-and-merger-is-correctly-connected-and-receiving-appropriate-learning-signals">Completing this phase successfully validates that the entire trainable pipeline (Stages B, D, and Merger) is correctly connected and receiving appropriate learning signals.</h1>
<p>Excellent points! These considerations highlight the practical nuances and potential friction points involved in implementing the proposed training plan. Let's analyze each one:</p>
<ol>
<li>
<p><strong>External Tool Dependency (DSSR) in Phase 1a:</strong></p>
<ul>
<li><strong>Analysis:</strong> You are correct. Relying on DSSR introduces an external dependency that requires separate installation and licensing (albeit free for academics). This contrasts with a pure Python dependency like MDAnalysis.</li>
<li><strong>Rationale Recap:</strong> The choice favoured DSSR because of its specialized accuracy and robustness in handling RNA complexities (conventions, modifications) out-of-the-box. The hypothesis is that the effort saved in <em>not</em> having to manually implement and rigorously validate angle calculations for all edge cases (especially inter-residue angles like , , ) using a general tool like MDAnalysis outweighs the one-time setup cost of DSSR. The risk of introducing subtle errors into the "ground truth" angles via manual implementation with MDAnalysis was deemed higher.</li>
<li><strong>Plan's Mitigation:</strong> The plan isolates this dependency into a single, explicit pre-computation script (<code>Phase 1a</code>).</li>
<li><strong>Refinement/Action:</strong><ul>
<li><strong>Documentation:</strong> The pre-computation script's README/documentation <em>must</em> clearly state the DSSR version dependency and link to its installation/licensing instructions.</li>
<li><strong>Error Handling:</strong> The script needs robust error handling to detect DSSR failures (e.g., binary not found, license issue, file parsing error) and provide informative messages.</li>
<li><strong>Reproducibility:</strong> Store the <em>exact</em> DSSR version used alongside the generated <code>.pt</code> files (e.g., in a manifest file) to ensure future reproducibility.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Complexity of AF3 Loss in Phase 2 (Action 5.1):</strong></p>
<ul>
<li><strong>Analysis:</strong> Agreed. Implementing the full AlphaFold 3 coordinate loss (Eq 6, involving Algo 27 <code>SmoothLDDTLoss</code> and Algo 28 <code>weighted_rigid_align</code>) is considerably more complex than a standard MSE or even a noise-prediction MSE.</li>
<li><strong>Rationale Recap:</strong> The plan explicitly recommends starting with the simpler <strong>noise prediction MSE loss</strong> (<code>loss_diffusion = F.mse_loss(predicted_noise, actual_noise, reduction='none'); loss_diffusion = (loss_diffusion * mask_for_loss).sum() / (mask_for_loss.sum() * 3 + 1e-8)</code>) as the default <code>L_diffusion</code>, <em>unless</em> the <code>ProtenixDiffusionManager</code> is definitively designed to output denoised coordinates (<code>\hat{x}_0</code>).</li>
<li><strong>Plan's Mitigation:</strong> The plan flags the coordinate loss path as complex and requiring specific algorithm implementations.</li>
<li><strong>Refinement/Action:</strong><ul>
<li><strong>Prioritize Noise Prediction:</strong> Strongly emphasize implementing and testing the noise prediction loss first. Only switch to the coordinate prediction loss if absolutely necessary and after the rest of the pipeline is stable.</li>
<li><strong>Sub-tasking:</strong> If coordinate loss <em>is</em> required, break down its implementation into distinct sub-tasks: (a) implement <code>weighted_rigid_align</code>, (b) implement <code>SmoothLDDTLoss</code>, (c) ensure atom-type data is available for weights <code>wl</code>, (d) implement the noise-level weighting factor from Eq 6. Treat this as a separate, significant development effort.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong><code>run_stageD</code> Implementation Details (Training Mode):</strong></p>
<ul>
<li><strong>Analysis:</strong> Correct. The plan identifies <em>that</em> <code>run_stageD</code> needs modification but not the precise internal changes. <code>_run_stageD_impl</code> currently calls <code>run_diffusion_and_handle_output</code>, which in turn calls <code>ProtenixDiffusionManager.multi_step_inference</code>. This inference path is unsuitable for training.</li>
<li><strong>Rationale Recap:</strong> The plan flags this as needing investigation.</li>
<li><strong>Refinement/Action:</strong><ul>
<li><strong>Recommended Approach:</strong> Modify <code>ProtenixDiffusionManager</code> to have a distinct <code>train_step</code> method (or adapt its <code>forward</code> method based on <code>self.training</code> or a <code>mode</code> flag). This method should take noisy coordinates, conditioning signals, and the noise level (<code>sigma_t</code>) as input, perform <em>one</em> step of the diffusion model's forward pass (predicting noise or denoised coords), and return that prediction.</li>
<li>Modify <code>run_stageD</code> / <code>_run_stageD_impl</code>: Add conditional logic based on <code>context.mode</code>. If <code>'train'</code>, it should call the new <code>diffusion_manager.train_step</code> method instead of <code>multi_step_inference</code>.</li>
<li><strong>Interface Clarity:</strong> Ensure the <em>return value</em> of <code>run_stageD</code> in training mode is clearly defined (e.g., just the predicted noise tensor, or a tuple/dict including it) so <code>RNALightningModule.training_step</code> knows what to expect for the loss calculation.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Bridging Function Robustness (<code>residue_to_atoms</code>, <code>derive_residue_atom_map</code>):</strong></p>
<ul>
<li><strong>Analysis:</strong> Valid concern. The entire conditioning signal's correctness hinges on these utilities mapping residue-level information (like <code>s_embeddings</code>) to the correct atom-level representation expected by Stage D.</li>
<li><strong>Rationale Recap:</strong> The plan uses these functions but implicitly assumes their correctness.</li>
<li><strong>Refinement/Action:</strong><ul>
<li><strong>Dedicated Unit Tests:</strong> Implement specific unit tests for <code>rna_predict.utils.tensor_utils.embedding.residue_to_atoms</code> and <code>rna_predict.utils.tensor_utils.residue_mapping.derive_residue_atom_map</code>.</li>
<li><strong>Test Cases:</strong> These tests should cover:<ul>
<li>Standard RNA sequences.</li>
<li>Sequences with varying lengths (requiring padding/truncation relative to <code>max_res</code>).</li>
<li>Cases with <code>atom_mask</code> indicating missing atoms.</li>
<li>Batch handling (if the functions are designed to be batched).</li>
<li>Correct output shapes and dtypes.</li>
<li>Correct mapping verification for a small, known example.</li>
</ul>
</li>
<li><strong>Placement:</strong> Add these tests under <code>tests/unit/utils/</code> or similar. Run them as part of the prerequisites before or during Phase 2 implementation.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Hyperparameter Tuning (Loss Weights):</strong></p>
<ul>
<li><strong>Analysis:</strong> Correct. The optimal <code>w_diffusion</code> and <code>w_angle</code> are unknown and will impact training dynamics.</li>
<li><strong>Rationale Recap:</strong> The plan sets up the structure (configurable weights) but defers the tuning.</li>
<li><strong>Refinement/Action:</strong><ul>
<li><strong>Acknowledge as Future Work:</strong> Explicitly state in documentation (e.g., a <code>docs/training_guide.md</code>) that loss weights are key hyperparameters requiring tuning <em>after</em> initial functionality is established.</li>
<li><strong>Suggest Initial Values:</strong> Recommend starting points (e.g., <code>w_diffusion=1.0</code>, <code>w_angle=0.1</code> or <code>w_angle=0.0</code> initially to isolate diffusion training).</li>
<li><strong>Tuning Strategy:</strong> Briefly mention potential tuning methods (manual adjustment based on validation loss curves, grid search, random search, Bayesian optimization).</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>Revised Hypothesis (Implicit):</strong></p>
<h1 id="while-the-implementation-plan-addresses-the-core-requirements-for-fixing-the-training-loop-successful-execution-hinges-on-careful-handling-of-the-identified-minor-considerations-specifically-managing-the-dssr-dependency-choosing-the-appropriate-diffusion-loss-complexity-correctly-adapting-the-run_staged-function-for-training-mode-rigorously-testing-the-bridging-utilities-and-planning-for-subsequent-hyperparameter-tuning-these-are-not-blockers-but-represent-key-areas-requiring-developer-attention-and-potentially-dedicated-effort-during-or-after-the-main-implementation-phases">While the implementation plan addresses the core requirements for fixing the training loop, successful execution hinges on careful handling of the identified "Minor Considerations," specifically: managing the DSSR dependency, choosing the appropriate diffusion loss complexity, correctly adapting the <code>run_stageD</code> function for training mode, rigorously testing the bridging utilities, and planning for subsequent hyperparameter tuning. These are not blockers but represent key areas requiring developer attention and potentially dedicated effort during or after the main implementation phases.</h1>
<p>Okay, let's analyze those MDAnalysis timings in the context of using it for on-the-fly angle calculation during training data loading.</p>
<p><strong>Analysis of Timings:</strong></p>
<ul>
<li><strong>Short Sequences (10-24 residues):</strong> 20-53 milliseconds per structure. This is very fast and unlikely to be a bottleneck.</li>
<li><strong>Longer Sequence (240 residues):</strong> 373 milliseconds (0.37 seconds) per structure. This is considerably longer.</li>
</ul>
<p><strong>Context: DataLoader Performance</strong></p>
<ul>
<li><strong><code>__getitem__</code> Impact:</strong> This calculation happens <em>every time</em> <code>RNADataset.__getitem__</code> is called for a sample.</li>
<li><strong><code>num_workers</code>:</strong> PyTorch's <code>DataLoader</code> uses multiple worker processes (<code>num_workers</code> in your config, default is 8) to prepare batches in parallel <em>ahead</em> of time. The goal is to have the next batch ready the moment the GPU finishes processing the current one.</li>
<li><strong>Bottleneck Identification:</strong> The <em>overall throughput</em> of the DataLoader is limited by the time it takes for workers to prepare samples. If the <em>average</em> time per sample (including file I/O, sequence loading, coordinate loading, <em>and</em> angle calculation) multiplied by the batch size, divided by the number of workers, is significantly <em>longer</em> than the time your model takes for one training step on the GPU, then data loading becomes the bottleneck, and your GPU will sit idle waiting for data.</li>
</ul>
<p><strong>Is 0.37s "Fast Enough"?</strong></p>
<ul>
<li><strong>For a Single Item:</strong> Maybe.</li>
<li><strong>For Training Throughput:</strong> <strong>Potentially problematic, especially for longer sequences.</strong><ul>
<li>If your dataset has many sequences around the 200-500 residue mark, each taking 0.3-0.5+ seconds just for angle calculation within <code>__getitem__</code>.</li>
<li>Even with 8 workers, if a few workers happen to be processing long sequences simultaneously, the time to assemble a full batch could easily exceed the time for a GPU training step (which might be &lt; 0.5s or even &lt; 0.1s depending on model size and hardware).</li>
<li>This leads to the GPU waiting, drastically slowing down your overall training time.</li>
</ul>
</li>
</ul>
<p><strong>Comparison with Pre-computation:</strong></p>
<ul>
<li><strong>Loading <code>.pt</code> file:</strong> Typically takes single-digit milliseconds (1-10ms), dominated by disk I/O.</li>
<li><strong>Difference:</strong> Pre-computation removes the 20ms-370ms+ calculation cost <em>entirely</em> from the training loop's data loading path.</li>
</ul>
<p><strong>Conclusion &amp; Recommendation:</strong></p>
<p>While you <em>can</em> proceed with on-the-fly MDAnalysis calculation, and it <em>will</em> work functionally (especially if your dataset is mostly short sequences or your <code>num_workers</code> is high relative to GPU speed), <strong>it is highly likely to become a performance bottleneck during training, potentially slowing it down significantly.</strong></p>
<p><strong>Strong Recommendation:</strong></p>
<p>Leverage the pre-computation script you already built (<code>compute_ground_truth_angles.py</code>).</p>
<ol>
<li>
<p><strong>Run Pre-computation with MDAnalysis:</strong> Execute your script <em>once</em> for your entire dataset using the MDAnalysis backend:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># Example command - adjust paths as needed</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>uv<span class="w"> </span>run<span class="w"> </span>rna_predict/dataset/preprocessing/compute_ground_truth_angles.py<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">    </span>--input_dir<span class="w"> </span>/path/to/your/pdb_cif_files<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span>--output_dir<span class="w"> </span>/path/to/store/angle_pt_files<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">    </span>--chain_id<span class="w"> </span>&lt;your_default_or_logic&gt;<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">    </span>--backend<span class="w"> </span>mdanalysis
</code></pre></div>
    <em>(Ensure the output directory is accessible or adjust paths in <code>RNADataset</code> accordingly)</em></p>
</li>
<li>
<p><strong>Revert <code>_load_angles</code> in <code>loader.py</code>:</strong> Change the <code>RNADataset._load_angles</code> method back to the <em>simpler version</em> designed in the refined plan, which just loads the pre-computed <code>.pt</code> file:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># Inside RNADataset class</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">_load_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads pre-computed ground truth torsion angles from a .pt file.&quot;&quot;&quot;</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="n">angle_path</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>        <span class="c1"># --- Logic to determine the ANGLE file path ---</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>        <span class="c1"># This MUST match how compute_ground_truth_angles.py saves files.</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>        <span class="c1"># Example: Assuming output_dir from compute script is accessible</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>        <span class="c1"># and uses naming like &lt;pdb_id&gt;_&lt;chain_id&gt;_angles.pt</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>        <span class="c1"># !! ADAPT THIS PATH LOGIC !!</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>        <span class="c1"># 1. Get base name (e.g., from row[&#39;id&#39;] or derived from row[&#39;filepath&#39;])</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>        <span class="n">base_name</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span> <span class="c1"># Or derive from filepath</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>        <span class="c1"># 2. Construct expected .pt filename</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>        <span class="c1">#    This assumes the compute script saved with _&lt;chain&gt;_angles.pt suffix</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>        <span class="n">chain_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;chain_id&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="c1"># Get chain if available, else default</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>        <span class="n">angle_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">chain_id</span><span class="si">}</span><span class="s2">_angles.pt&quot;</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>        <span class="c1"># 3. Define the directory where compute_script saved the files</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>        <span class="c1">#    This might need to be configurable via cfg.data.angle_dir</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>        <span class="n">angle_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">angle_dir</span><span class="p">)</span> <span class="c1"># Add angle_dir to your config!</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>        <span class="n">angle_path</span> <span class="o">=</span> <span class="n">angle_dir</span> <span class="o">/</span> <span class="n">angle_fname</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>        <span class="c1"># --- End Path Logic ---</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">angle_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pre-computed angle file not found: </span><span class="si">{</span><span class="n">angle_path</span><span class="si">}</span><span class="s2">. Returning None.&quot;</span><span class="p">)</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>        <span class="c1"># Load the tensor data</span>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>        <span class="n">angles_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">angle_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a>
<a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a>        <span class="c1"># Basic validation (optional)</span>
<a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">angles_tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">or</span> <span class="n">angles_tensor</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">angles_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span>
<a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid data in pre-computed angle file </span><span class="si">{</span><span class="n">angle_path</span><span class="si">}</span><span class="s2">. Shape: </span><span class="si">{</span><span class="n">angles_tensor</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">angles_tensor</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>             <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>
<a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>        <span class="k">return</span> <span class="n">angles_tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="c1"># Ensure correct dtype</span>
<a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a>
<a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading pre-computed angles for </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">angle_path</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">angle_path</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;unknown path&#39;</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>Advantages of this approach:</strong></p>
<ul>
<li><strong>Best Performance:</strong> Ensures fastest possible data loading during training.</li>
<li><strong>Leverages Existing Work:</strong> Uses the <code>compute_ground_truth_angles.py</code> script you already wrote and tested.</li>
<li><strong>Clean Separation:</strong> Keeps calculation (pre-computation) separate from loading (<code>RNADataset</code>).</li>
<li><strong>Future-Proof:</strong> When DSSR is ready, you simply re-run the <em>same</em> pre-computation script with <code>--backend dssr</code> without changing the DataLoader.</li>
</ul>
<p>While on-the-fly calculation is tempting as a temporary measure, investing the time now to run the pre-computation (even with MDAnalysis) will likely save significant training time later.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>