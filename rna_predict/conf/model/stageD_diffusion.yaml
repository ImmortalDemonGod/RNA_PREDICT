# rna_predict/conf/model/stageD_diffusion.yaml
# Configuration for Stage D: Diffusion-based Refinement
# Based on docs/pipeline/integration/hydra_integration/components/stageD/StageD_Diffusion_Refinement.md

defaults:
  - _self_

enabled: true
model_architecture:
  c_token: 384
  c_s: 384
  c_z: 128
  c_s_inputs: 449
  c_atom: 128
  # c_pair is sometimes required for diffusion model overrides
  c_noise_embedding: 32
atom_decoder:
  c_in: 64
  c_hidden: [128, 64, 32]
  c_out: 3
  dropout: 0.1
  n_blocks: 1
  n_heads: 2
  n_queries: 1
  n_keys: 1
diffusion:
  # Core settings
  init_from_scratch: false
  enabled: true
  mode: "inference"
  device: "cpu"
  debug_logging: true
  # Feature dimensions required for bridging
  feature_dimensions:
    c_s: ${..model_architecture.c_s}         # matches c_s in model_architecture
    c_s_inputs: ${..model_architecture.c_s_inputs}  # matches c_s_inputs in model_architecture
    c_sing: ${..model_architecture.c_s}      # set to same as c_s for consistency
    s_trunk: ${..model_architecture.c_s}
  # Required for residue-to-atom bridging and inference shape checks
  test_residues_per_batch: 1
  # Required model architecture configuration
  model_architecture: ${..model_architecture}
  # Required transformer configuration
  transformer:
    n_blocks: 1
    n_heads: 1
    blocks_per_ckpt: 1
  # Atom encoder/decoder configs
  atom_encoder:
    c_in: 3
    c_hidden: [32, 64, 128]
    c_out: 64
    dropout: 0.1
  atom_decoder:
    c_in: 64
    c_hidden: [128, 64, 32]
    c_out: 3
    dropout: 0.1
  # Noise schedule config
  noise_schedule:
    schedule_type: "linear"
    s_max: 160.0
    s_min: 0.0004
    p: 7.0
    sigma_data: 16.0
    p_mean: -1.2
    p_std: 1.5
  # Inference config
  inference:
    num_steps: 2
    temperature: 1.0
    use_ddim: True
    sampling:
      num_samples: 1
      gamma0: 0.8
      gamma_min: 1.0
      noise_scale_lambda: 1.003
      step_scale_eta: 1.5
  # Memory optimization
  use_memory_efficient_kernel: False
  use_deepspeed_evo_attention: False
  use_lma: False
  inplace_safe: False
  chunk_size: null
