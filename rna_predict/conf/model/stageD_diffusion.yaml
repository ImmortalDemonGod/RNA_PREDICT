# rna_predict/conf/model/stageD_diffusion.yaml
# Configuration for Stage D: Diffusion-based Refinement
# Based on docs/pipeline/integration/hydra_integration/components/stageD/StageD_Diffusion_Refinement.md

defaults:
  - _self_

# Top-level settings
enabled: true

# Diffusion model settings
# Set all minimal values for memory-efficient testing

diffusion:
  # Core settings
  init_from_scratch: false
  enabled: true
  mode: "inference"
  device: "cpu"
  debug_logging: true
  sigma_data: 1.0
  c_atom: 2
  c_s: 2
  c_z: 2
  c_s_inputs: 2
  c_noise_embedding: 2
  ref_element_size: 2
  ref_atom_name_chars_size: 2

  # Feature dimensions required for bridging
  feature_dimensions:
    c_s: 2         # matches c_s in model_architecture
    c_s_inputs: 2  # matches c_s_inputs in model_architecture
    c_sing: 2      # set to same as c_s for minimal config

  # Required for residue-to-atom bridging and inference shape checks
  test_residues_per_batch: 1

  # Required model architecture configuration
  model_architecture:
    c_token: 2
    c_s: 2
    c_z: 2
    c_s_inputs: 2
    c_atom: 2
    c_noise_embedding: 2
    num_layers: 1
    num_heads: 1
    dropout: 0.0
    coord_eps: 1e-6
    coord_min: -1e4
    coord_max: 1e4
    coord_similarity_rtol: 1e-3
    test_residues_per_batch: 1

  # Required transformer configuration
  transformer:
    n_blocks: 1
    n_heads: 1
    blocks_per_ckpt: 1

  # Required atom encoder configuration
  atom_encoder:
    c_in: 1
    c_hidden: [2]
    c_out: 1
    dropout: 0.0
    n_blocks: 1
    n_heads: 1
    n_queries: 1
    n_keys: 1

  # Required atom decoder configuration
  atom_decoder:
    c_in: 1
    c_hidden: [2]
    c_out: 1
    dropout: 0.0
    n_blocks: 1
    n_heads: 1
    n_queries: 1
    n_keys: 1

  # Noise schedule configuration
  noise_schedule:
    schedule_type: "linear"
    sigma_data: 1.0
    s_max: 1.0
    s_min: 1e-4
    p: 1.0
    p_mean: 0.0
    p_std: 1.0

  # Inference parameters
  inference:
    num_steps: 2
    temperature: 1.0
    use_ddim: true
    sampling:
      num_samples: 1
      gamma0: 1.0
      gamma_min: 1.0
      noise_scale_lambda: 1.0
      step_scale_eta: 1.0

  # Memory optimization flags
  use_memory_efficient_kernel: false
  use_deepspeed_evo_attention: false
  use_lma: false
  inplace_safe: false
  chunk_size: null

  atom_metadata: null
